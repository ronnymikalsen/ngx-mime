import * as d3 from 'd3';
import * as OpenSeadragon from 'openseadragon';
import { ViewerOptions } from '../models/viewer-options';
import { Rect } from '../models/rect';
import { Subject } from 'rxjs';
import { takeUntil } from 'rxjs/operators';
var CanvasGroupMask = /** @class */ (function () {
    function CanvasGroupMask(viewer, styleService) {
        var _this = this;
        this.styleService = styleService;
        this.disableResize = false;
        this.destroyed = new Subject();
        this.animationHandler = function () {
            _this.resize();
        };
        this.resizeHandler = function () {
            _this.setCenter();
            _this.resize();
        };
        this.canvasGroupPinchHandler = function () {
            _this.disableResize = false;
        };
        this.canvasGroupDragHandler = function (e) {
            if ((e.delta.x || e.delta.y) && e.speed > 0 && e.direction !== 0) {
                _this.disableResize = true;
            }
        };
        this.canvasGroupDragEndHandler = function () {
            _this.disableResize = false;
            _this.resize();
        };
        this.viewer = viewer;
        styleService.onChange.pipe(takeUntil(this.destroyed)).subscribe(function (c) {
            _this.backgroundColor = c;
            if (_this.leftMask) {
                _this.leftMask.style('fill', _this.backgroundColor);
            }
            if (_this.rightMask) {
                _this.rightMask.style('fill', _this.backgroundColor);
            }
        });
    }
    CanvasGroupMask.prototype.initialise = function (pageBounds, visible) {
        this.canvasGroupRect = pageBounds;
        this.addCanvasGroupMask();
        this.setCenter();
        this.resize();
        if (visible) {
            this.show();
        }
        else {
            this.hide();
        }
    };
    CanvasGroupMask.prototype.destroy = function () {
        this.destroyed.next();
        this.destroyed.complete();
    };
    CanvasGroupMask.prototype.changeCanvasGroup = function (pageBounds) {
        this.canvasGroupRect = pageBounds;
        this.resize();
    };
    CanvasGroupMask.prototype.show = function () {
        this.addHandlers();
        if (!this.leftMask || !this.rightMask) {
            return;
        }
        this.setCenter();
        this.resize();
        this.leftMask.attr('height', '100%');
        this.rightMask.attr('height', '100%');
    };
    CanvasGroupMask.prototype.hide = function () {
        this.removeHandlers();
        if (!this.leftMask || !this.rightMask) {
            return;
        }
        this.leftMask.attr('height', '0');
        this.rightMask.attr('height', '0');
    };
    CanvasGroupMask.prototype.addHandlers = function () {
        this.viewer.addHandler('animation', this.animationHandler);
        this.viewer.addHandler('resize', this.resizeHandler);
        this.viewer.addHandler('canvas-pinch', this.canvasGroupPinchHandler);
        this.viewer.addHandler('canvas-drag', this.canvasGroupDragHandler);
        this.viewer.addHandler('canvas-drag-end', this.canvasGroupDragEndHandler);
    };
    CanvasGroupMask.prototype.removeHandlers = function () {
        this.viewer.removeHandler('animation', this.animationHandler);
        this.viewer.removeHandler('resize', this.resizeHandler);
        this.viewer.removeHandler('canvas-pinch', this.canvasGroupPinchHandler);
        this.viewer.removeHandler('canvas-drag', this.canvasGroupDragHandler);
        this.viewer.removeHandler('canvas-drag-end', this.canvasGroupDragEndHandler);
    };
    CanvasGroupMask.prototype.addCanvasGroupMask = function () {
        var overlays = d3.select(this.viewer.svgOverlay().node().parentNode);
        var mask = overlays.append('g').attr('id', 'page-mask');
        this.leftMask = mask
            .append('rect')
            .attr('id', 'mime-left-page-mask')
            .attr('height', '100%')
            .attr('y', 0)
            .style('fill', this.backgroundColor);
        this.rightMask = mask
            .append('rect')
            .attr('id', 'mime-right-page-mask')
            .attr('height', '100%')
            .attr('y', 0)
            .style('fill', this.backgroundColor);
    };
    CanvasGroupMask.prototype.setCenter = function () {
        this.center = new OpenSeadragon.Point(this.viewer.viewport._containerInnerSize.x / 2, this.viewer.viewport._containerInnerSize.y / 2);
    };
    CanvasGroupMask.prototype.resize = function () {
        if (this.disableResize || !this.leftMask || !this.rightMask) {
            return;
        }
        var leftMaskRect = this.getLeftMaskRect();
        var rightMaskRect = this.getRightMaskRect();
        this.leftMask.attr('width', leftMaskRect.width).attr('x', leftMaskRect.x);
        this.rightMask
            .attr('width', rightMaskRect.width)
            .attr('x', Math.round(rightMaskRect.x));
    };
    CanvasGroupMask.prototype.getLeftMaskRect = function () {
        var imgBounds = new OpenSeadragon.Rect(this.canvasGroupRect.x, this.canvasGroupRect.y, this.canvasGroupRect.width, this.canvasGroupRect.height);
        var topLeft = this.viewer.viewport.viewportToViewerElementCoordinates(imgBounds.getTopLeft());
        var width = topLeft.x - ViewerOptions.overlays.canvasGroupMarginInPageView;
        if (width < 0) {
            width = 0;
        }
        return new Rect({
            x: 0,
            width: width
        });
    };
    CanvasGroupMask.prototype.getRightMaskRect = function () {
        var imgBounds = new OpenSeadragon.Rect(this.canvasGroupRect.x, this.canvasGroupRect.y, this.canvasGroupRect.width, this.canvasGroupRect.height);
        var topRight = this.viewer.viewport.viewportToViewerElementCoordinates(imgBounds.getTopRight());
        var width = this.viewer.viewport._containerInnerSize.x - topRight.x;
        var x = this.viewer.viewport._containerInnerSize.x -
            width +
            ViewerOptions.overlays.canvasGroupMarginInPageView;
        if (width < 0) {
            width = 0;
        }
        return new Rect({
            x: x,
            width: width
        });
    };
    return CanvasGroupMask;
}());
export { CanvasGroupMask };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FudmFzLWdyb3VwLW1hc2suanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AbmF0aW9uYWxsaWJyYXJ5b2Zub3J3YXkvbmd4LW1pbWUvIiwic291cmNlcyI6WyJsaWIvY29yZS92aWV3ZXItc2VydmljZS9jYW52YXMtZ3JvdXAtbWFzay50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEtBQUssRUFBRSxNQUFNLElBQUksQ0FBQztBQUN6QixPQUFPLEtBQUssYUFBYSxNQUFNLGVBQWUsQ0FBQztBQUUvQyxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFFekQsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXRDLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDL0IsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRTNDO0lBYUUseUJBQVksTUFBVyxFQUFVLFlBQTBCO1FBQTNELGlCQVdDO1FBWGdDLGlCQUFZLEdBQVosWUFBWSxDQUFjO1FBTjNELGtCQUFhLEdBQUcsS0FBSyxDQUFDO1FBSWQsY0FBUyxHQUFrQixJQUFJLE9BQU8sRUFBRSxDQUFDO1FBK0V6QyxxQkFBZ0IsR0FBRztZQUN6QixLQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDaEIsQ0FBQyxDQUFDO1FBRU0sa0JBQWEsR0FBRztZQUN0QixLQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7WUFDakIsS0FBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBQ2hCLENBQUMsQ0FBQztRQUVNLDRCQUF1QixHQUFHO1lBQ2hDLEtBQUksQ0FBQyxhQUFhLEdBQUcsS0FBSyxDQUFDO1FBQzdCLENBQUMsQ0FBQztRQUVNLDJCQUFzQixHQUFHLFVBQUMsQ0FBTTtZQUN0QyxJQUFJLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsS0FBSyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsU0FBUyxLQUFLLENBQUMsRUFBRTtnQkFDaEUsS0FBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLENBQUM7YUFDM0I7UUFDSCxDQUFDLENBQUM7UUFFTSw4QkFBeUIsR0FBRztZQUNsQyxLQUFJLENBQUMsYUFBYSxHQUFHLEtBQUssQ0FBQztZQUMzQixLQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDaEIsQ0FBQyxDQUFDO1FBbEdBLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBQ3JCLFlBQVksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsVUFBQSxDQUFDO1lBQy9ELEtBQUksQ0FBQyxlQUFlLEdBQUcsQ0FBQyxDQUFDO1lBQ3pCLElBQUksS0FBSSxDQUFDLFFBQVEsRUFBRTtnQkFDakIsS0FBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFLEtBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQzthQUNuRDtZQUNELElBQUksS0FBSSxDQUFDLFNBQVMsRUFBRTtnQkFDbEIsS0FBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFLEtBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQzthQUNwRDtRQUNILENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVNLG9DQUFVLEdBQWpCLFVBQWtCLFVBQWdCLEVBQUUsT0FBZ0I7UUFDbEQsSUFBSSxDQUFDLGVBQWUsR0FBRyxVQUFVLENBQUM7UUFFbEMsSUFBSSxDQUFDLGtCQUFrQixFQUFFLENBQUM7UUFFMUIsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO1FBQ2pCLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztRQUVkLElBQUksT0FBTyxFQUFFO1lBQ1gsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1NBQ2I7YUFBTTtZQUNMLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztTQUNiO0lBQ0gsQ0FBQztJQUVNLGlDQUFPLEdBQWQ7UUFDRSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ3RCLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDNUIsQ0FBQztJQUVNLDJDQUFpQixHQUF4QixVQUF5QixVQUFnQjtRQUN2QyxJQUFJLENBQUMsZUFBZSxHQUFHLFVBQVUsQ0FBQztRQUNsQyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7SUFDaEIsQ0FBQztJQUVNLDhCQUFJLEdBQVg7UUFDRSxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDbkIsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFO1lBQ3JDLE9BQU87U0FDUjtRQUNELElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQztRQUNqQixJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7UUFDZCxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDckMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLE1BQU0sQ0FBQyxDQUFDO0lBQ3hDLENBQUM7SUFFTSw4QkFBSSxHQUFYO1FBQ0UsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO1FBQ3RCLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUNyQyxPQUFPO1NBQ1I7UUFDRCxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDbEMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ3JDLENBQUM7SUFFTyxxQ0FBVyxHQUFuQjtRQUNFLElBQUksQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLFdBQVcsRUFBRSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztRQUMzRCxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ3JELElBQUksQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLGNBQWMsRUFBRSxJQUFJLENBQUMsdUJBQXVCLENBQUMsQ0FBQztRQUNyRSxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxhQUFhLEVBQUUsSUFBSSxDQUFDLHNCQUFzQixDQUFDLENBQUM7UUFDbkUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsaUJBQWlCLEVBQUUsSUFBSSxDQUFDLHlCQUF5QixDQUFDLENBQUM7SUFDNUUsQ0FBQztJQUVPLHdDQUFjLEdBQXRCO1FBQ0UsSUFBSSxDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUMsV0FBVyxFQUFFLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1FBQzlELElBQUksQ0FBQyxNQUFNLENBQUMsYUFBYSxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDeEQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUMsY0FBYyxFQUFFLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDO1FBQ3hFLElBQUksQ0FBQyxNQUFNLENBQUMsYUFBYSxDQUFDLGFBQWEsRUFBRSxJQUFJLENBQUMsc0JBQXNCLENBQUMsQ0FBQztRQUN0RSxJQUFJLENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FDdkIsaUJBQWlCLEVBQ2pCLElBQUksQ0FBQyx5QkFBeUIsQ0FDL0IsQ0FBQztJQUNKLENBQUM7SUEwQk8sNENBQWtCLEdBQTFCO1FBQ0UsSUFBTSxRQUFRLEdBQUcsRUFBRSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsRUFBRSxDQUFDLElBQUksRUFBRSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBRXZFLElBQU0sSUFBSSxHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxXQUFXLENBQUMsQ0FBQztRQUUxRCxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUk7YUFDakIsTUFBTSxDQUFDLE1BQU0sQ0FBQzthQUNkLElBQUksQ0FBQyxJQUFJLEVBQUUscUJBQXFCLENBQUM7YUFDakMsSUFBSSxDQUFDLFFBQVEsRUFBRSxNQUFNLENBQUM7YUFDdEIsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7YUFDWixLQUFLLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQztRQUV2QyxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUk7YUFDbEIsTUFBTSxDQUFDLE1BQU0sQ0FBQzthQUNkLElBQUksQ0FBQyxJQUFJLEVBQUUsc0JBQXNCLENBQUM7YUFDbEMsSUFBSSxDQUFDLFFBQVEsRUFBRSxNQUFNLENBQUM7YUFDdEIsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7YUFDWixLQUFLLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQztJQUN6QyxDQUFDO0lBRU8sbUNBQVMsR0FBakI7UUFDRSxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksYUFBYSxDQUFDLEtBQUssQ0FDbkMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsbUJBQW1CLENBQUMsQ0FBQyxHQUFHLENBQUMsRUFDOUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsbUJBQW1CLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FDL0MsQ0FBQztJQUNKLENBQUM7SUFFTyxnQ0FBTSxHQUFkO1FBQ0UsSUFBSSxJQUFJLENBQUMsYUFBYSxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUU7WUFDM0QsT0FBTztTQUNSO1FBRUQsSUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO1FBQzVDLElBQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1FBQzlDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxZQUFZLENBQUMsS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDMUUsSUFBSSxDQUFDLFNBQVM7YUFDWCxJQUFJLENBQUMsT0FBTyxFQUFFLGFBQWEsQ0FBQyxLQUFLLENBQUM7YUFDbEMsSUFBSSxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQzVDLENBQUM7SUFFTyx5Q0FBZSxHQUF2QjtRQUNFLElBQU0sU0FBUyxHQUFHLElBQUksYUFBYSxDQUFDLElBQUksQ0FDdEMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDLEVBQ3RCLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQyxFQUN0QixJQUFJLENBQUMsZUFBZSxDQUFDLEtBQUssRUFDMUIsSUFBSSxDQUFDLGVBQWUsQ0FBQyxNQUFNLENBQzVCLENBQUM7UUFDRixJQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxrQ0FBa0MsQ0FDckUsU0FBUyxDQUFDLFVBQVUsRUFBRSxDQUN2QixDQUFDO1FBQ0YsSUFBSSxLQUFLLEdBQUcsT0FBTyxDQUFDLENBQUMsR0FBRyxhQUFhLENBQUMsUUFBUSxDQUFDLDJCQUEyQixDQUFDO1FBRTNFLElBQUksS0FBSyxHQUFHLENBQUMsRUFBRTtZQUNiLEtBQUssR0FBRyxDQUFDLENBQUM7U0FDWDtRQUVELE9BQU8sSUFBSSxJQUFJLENBQUM7WUFDZCxDQUFDLEVBQUUsQ0FBQztZQUNKLEtBQUssRUFBRSxLQUFLO1NBQ2IsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVPLDBDQUFnQixHQUF4QjtRQUNFLElBQU0sU0FBUyxHQUFHLElBQUksYUFBYSxDQUFDLElBQUksQ0FDdEMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDLEVBQ3RCLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQyxFQUN0QixJQUFJLENBQUMsZUFBZSxDQUFDLEtBQUssRUFDMUIsSUFBSSxDQUFDLGVBQWUsQ0FBQyxNQUFNLENBQzVCLENBQUM7UUFDRixJQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxrQ0FBa0MsQ0FDdEUsU0FBUyxDQUFDLFdBQVcsRUFBRSxDQUN4QixDQUFDO1FBQ0YsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsbUJBQW1CLENBQUMsQ0FBQyxHQUFHLFFBQVEsQ0FBQyxDQUFDLENBQUM7UUFDcEUsSUFBTSxDQUFDLEdBQ0wsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsbUJBQW1CLENBQUMsQ0FBQztZQUMxQyxLQUFLO1lBQ0wsYUFBYSxDQUFDLFFBQVEsQ0FBQywyQkFBMkIsQ0FBQztRQUVyRCxJQUFJLEtBQUssR0FBRyxDQUFDLEVBQUU7WUFDYixLQUFLLEdBQUcsQ0FBQyxDQUFDO1NBQ1g7UUFFRCxPQUFPLElBQUksSUFBSSxDQUFDO1lBQ2QsQ0FBQyxFQUFFLENBQUM7WUFDSixLQUFLLEVBQUUsS0FBSztTQUNiLENBQUMsQ0FBQztJQUNMLENBQUM7SUFDSCxzQkFBQztBQUFELENBQUMsQUF6TUQsSUF5TUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBkMyBmcm9tICdkMyc7XG5pbXBvcnQgKiBhcyBPcGVuU2VhZHJhZ29uIGZyb20gJ29wZW5zZWFkcmFnb24nO1xuXG5pbXBvcnQgeyBWaWV3ZXJPcHRpb25zIH0gZnJvbSAnLi4vbW9kZWxzL3ZpZXdlci1vcHRpb25zJztcbmltcG9ydCB7IFBvaW50IH0gZnJvbSAnLi4vbW9kZWxzL3BvaW50JztcbmltcG9ydCB7IFJlY3QgfSBmcm9tICcuLi9tb2RlbHMvcmVjdCc7XG5pbXBvcnQgeyBTdHlsZVNlcnZpY2UgfSBmcm9tICcuLi9zdHlsZS1zZXJ2aWNlL3N0eWxlLnNlcnZpY2UnO1xuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgdGFrZVVudGlsIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5leHBvcnQgY2xhc3MgQ2FudmFzR3JvdXBNYXNrIHtcbiAgdmlld2VyOiBhbnk7XG4gIGNhbnZhc0dyb3VwUmVjdDogUmVjdDtcblxuICBsZWZ0TWFzazogYW55O1xuICByaWdodE1hc2s6IGFueTtcblxuICBkaXNhYmxlUmVzaXplID0gZmFsc2U7XG4gIGNlbnRlcjogUG9pbnQ7XG5cbiAgYmFja2dyb3VuZENvbG9yOiBzdHJpbmc7XG4gIHByaXZhdGUgZGVzdHJveWVkOiBTdWJqZWN0PHZvaWQ+ID0gbmV3IFN1YmplY3QoKTtcblxuICBjb25zdHJ1Y3Rvcih2aWV3ZXI6IGFueSwgcHJpdmF0ZSBzdHlsZVNlcnZpY2U6IFN0eWxlU2VydmljZSkge1xuICAgIHRoaXMudmlld2VyID0gdmlld2VyO1xuICAgIHN0eWxlU2VydmljZS5vbkNoYW5nZS5waXBlKHRha2VVbnRpbCh0aGlzLmRlc3Ryb3llZCkpLnN1YnNjcmliZShjID0+IHtcbiAgICAgIHRoaXMuYmFja2dyb3VuZENvbG9yID0gYztcbiAgICAgIGlmICh0aGlzLmxlZnRNYXNrKSB7XG4gICAgICAgIHRoaXMubGVmdE1hc2suc3R5bGUoJ2ZpbGwnLCB0aGlzLmJhY2tncm91bmRDb2xvcik7XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5yaWdodE1hc2spIHtcbiAgICAgICAgdGhpcy5yaWdodE1hc2suc3R5bGUoJ2ZpbGwnLCB0aGlzLmJhY2tncm91bmRDb2xvcik7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgaW5pdGlhbGlzZShwYWdlQm91bmRzOiBSZWN0LCB2aXNpYmxlOiBib29sZWFuKTogdm9pZCB7XG4gICAgdGhpcy5jYW52YXNHcm91cFJlY3QgPSBwYWdlQm91bmRzO1xuXG4gICAgdGhpcy5hZGRDYW52YXNHcm91cE1hc2soKTtcblxuICAgIHRoaXMuc2V0Q2VudGVyKCk7XG4gICAgdGhpcy5yZXNpemUoKTtcblxuICAgIGlmICh2aXNpYmxlKSB7XG4gICAgICB0aGlzLnNob3coKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5oaWRlKCk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGRlc3Ryb3koKSB7XG4gICAgdGhpcy5kZXN0cm95ZWQubmV4dCgpO1xuICAgIHRoaXMuZGVzdHJveWVkLmNvbXBsZXRlKCk7XG4gIH1cblxuICBwdWJsaWMgY2hhbmdlQ2FudmFzR3JvdXAocGFnZUJvdW5kczogUmVjdCkge1xuICAgIHRoaXMuY2FudmFzR3JvdXBSZWN0ID0gcGFnZUJvdW5kcztcbiAgICB0aGlzLnJlc2l6ZSgpO1xuICB9XG5cbiAgcHVibGljIHNob3coKTogdm9pZCB7XG4gICAgdGhpcy5hZGRIYW5kbGVycygpO1xuICAgIGlmICghdGhpcy5sZWZ0TWFzayB8fCAhdGhpcy5yaWdodE1hc2spIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5zZXRDZW50ZXIoKTtcbiAgICB0aGlzLnJlc2l6ZSgpO1xuICAgIHRoaXMubGVmdE1hc2suYXR0cignaGVpZ2h0JywgJzEwMCUnKTtcbiAgICB0aGlzLnJpZ2h0TWFzay5hdHRyKCdoZWlnaHQnLCAnMTAwJScpO1xuICB9XG5cbiAgcHVibGljIGhpZGUoKTogdm9pZCB7XG4gICAgdGhpcy5yZW1vdmVIYW5kbGVycygpO1xuICAgIGlmICghdGhpcy5sZWZ0TWFzayB8fCAhdGhpcy5yaWdodE1hc2spIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5sZWZ0TWFzay5hdHRyKCdoZWlnaHQnLCAnMCcpO1xuICAgIHRoaXMucmlnaHRNYXNrLmF0dHIoJ2hlaWdodCcsICcwJyk7XG4gIH1cblxuICBwcml2YXRlIGFkZEhhbmRsZXJzKCkge1xuICAgIHRoaXMudmlld2VyLmFkZEhhbmRsZXIoJ2FuaW1hdGlvbicsIHRoaXMuYW5pbWF0aW9uSGFuZGxlcik7XG4gICAgdGhpcy52aWV3ZXIuYWRkSGFuZGxlcigncmVzaXplJywgdGhpcy5yZXNpemVIYW5kbGVyKTtcbiAgICB0aGlzLnZpZXdlci5hZGRIYW5kbGVyKCdjYW52YXMtcGluY2gnLCB0aGlzLmNhbnZhc0dyb3VwUGluY2hIYW5kbGVyKTtcbiAgICB0aGlzLnZpZXdlci5hZGRIYW5kbGVyKCdjYW52YXMtZHJhZycsIHRoaXMuY2FudmFzR3JvdXBEcmFnSGFuZGxlcik7XG4gICAgdGhpcy52aWV3ZXIuYWRkSGFuZGxlcignY2FudmFzLWRyYWctZW5kJywgdGhpcy5jYW52YXNHcm91cERyYWdFbmRIYW5kbGVyKTtcbiAgfVxuXG4gIHByaXZhdGUgcmVtb3ZlSGFuZGxlcnMoKSB7XG4gICAgdGhpcy52aWV3ZXIucmVtb3ZlSGFuZGxlcignYW5pbWF0aW9uJywgdGhpcy5hbmltYXRpb25IYW5kbGVyKTtcbiAgICB0aGlzLnZpZXdlci5yZW1vdmVIYW5kbGVyKCdyZXNpemUnLCB0aGlzLnJlc2l6ZUhhbmRsZXIpO1xuICAgIHRoaXMudmlld2VyLnJlbW92ZUhhbmRsZXIoJ2NhbnZhcy1waW5jaCcsIHRoaXMuY2FudmFzR3JvdXBQaW5jaEhhbmRsZXIpO1xuICAgIHRoaXMudmlld2VyLnJlbW92ZUhhbmRsZXIoJ2NhbnZhcy1kcmFnJywgdGhpcy5jYW52YXNHcm91cERyYWdIYW5kbGVyKTtcbiAgICB0aGlzLnZpZXdlci5yZW1vdmVIYW5kbGVyKFxuICAgICAgJ2NhbnZhcy1kcmFnLWVuZCcsXG4gICAgICB0aGlzLmNhbnZhc0dyb3VwRHJhZ0VuZEhhbmRsZXJcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBhbmltYXRpb25IYW5kbGVyID0gKCkgPT4ge1xuICAgIHRoaXMucmVzaXplKCk7XG4gIH07XG5cbiAgcHJpdmF0ZSByZXNpemVIYW5kbGVyID0gKCkgPT4ge1xuICAgIHRoaXMuc2V0Q2VudGVyKCk7XG4gICAgdGhpcy5yZXNpemUoKTtcbiAgfTtcblxuICBwcml2YXRlIGNhbnZhc0dyb3VwUGluY2hIYW5kbGVyID0gKCkgPT4ge1xuICAgIHRoaXMuZGlzYWJsZVJlc2l6ZSA9IGZhbHNlO1xuICB9O1xuXG4gIHByaXZhdGUgY2FudmFzR3JvdXBEcmFnSGFuZGxlciA9IChlOiBhbnkpID0+IHtcbiAgICBpZiAoKGUuZGVsdGEueCB8fCBlLmRlbHRhLnkpICYmIGUuc3BlZWQgPiAwICYmIGUuZGlyZWN0aW9uICE9PSAwKSB7XG4gICAgICB0aGlzLmRpc2FibGVSZXNpemUgPSB0cnVlO1xuICAgIH1cbiAgfTtcblxuICBwcml2YXRlIGNhbnZhc0dyb3VwRHJhZ0VuZEhhbmRsZXIgPSAoKSA9PiB7XG4gICAgdGhpcy5kaXNhYmxlUmVzaXplID0gZmFsc2U7XG4gICAgdGhpcy5yZXNpemUoKTtcbiAgfTtcblxuICBwcml2YXRlIGFkZENhbnZhc0dyb3VwTWFzaygpIHtcbiAgICBjb25zdCBvdmVybGF5cyA9IGQzLnNlbGVjdCh0aGlzLnZpZXdlci5zdmdPdmVybGF5KCkubm9kZSgpLnBhcmVudE5vZGUpO1xuXG4gICAgY29uc3QgbWFzayA9IG92ZXJsYXlzLmFwcGVuZCgnZycpLmF0dHIoJ2lkJywgJ3BhZ2UtbWFzaycpO1xuXG4gICAgdGhpcy5sZWZ0TWFzayA9IG1hc2tcbiAgICAgIC5hcHBlbmQoJ3JlY3QnKVxuICAgICAgLmF0dHIoJ2lkJywgJ21pbWUtbGVmdC1wYWdlLW1hc2snKVxuICAgICAgLmF0dHIoJ2hlaWdodCcsICcxMDAlJylcbiAgICAgIC5hdHRyKCd5JywgMClcbiAgICAgIC5zdHlsZSgnZmlsbCcsIHRoaXMuYmFja2dyb3VuZENvbG9yKTtcblxuICAgIHRoaXMucmlnaHRNYXNrID0gbWFza1xuICAgICAgLmFwcGVuZCgncmVjdCcpXG4gICAgICAuYXR0cignaWQnLCAnbWltZS1yaWdodC1wYWdlLW1hc2snKVxuICAgICAgLmF0dHIoJ2hlaWdodCcsICcxMDAlJylcbiAgICAgIC5hdHRyKCd5JywgMClcbiAgICAgIC5zdHlsZSgnZmlsbCcsIHRoaXMuYmFja2dyb3VuZENvbG9yKTtcbiAgfVxuXG4gIHByaXZhdGUgc2V0Q2VudGVyKCk6IHZvaWQge1xuICAgIHRoaXMuY2VudGVyID0gbmV3IE9wZW5TZWFkcmFnb24uUG9pbnQoXG4gICAgICB0aGlzLnZpZXdlci52aWV3cG9ydC5fY29udGFpbmVySW5uZXJTaXplLnggLyAyLFxuICAgICAgdGhpcy52aWV3ZXIudmlld3BvcnQuX2NvbnRhaW5lcklubmVyU2l6ZS55IC8gMlxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIHJlc2l6ZSgpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5kaXNhYmxlUmVzaXplIHx8ICF0aGlzLmxlZnRNYXNrIHx8ICF0aGlzLnJpZ2h0TWFzaykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IGxlZnRNYXNrUmVjdCA9IHRoaXMuZ2V0TGVmdE1hc2tSZWN0KCk7XG4gICAgY29uc3QgcmlnaHRNYXNrUmVjdCA9IHRoaXMuZ2V0UmlnaHRNYXNrUmVjdCgpO1xuICAgIHRoaXMubGVmdE1hc2suYXR0cignd2lkdGgnLCBsZWZ0TWFza1JlY3Qud2lkdGgpLmF0dHIoJ3gnLCBsZWZ0TWFza1JlY3QueCk7XG4gICAgdGhpcy5yaWdodE1hc2tcbiAgICAgIC5hdHRyKCd3aWR0aCcsIHJpZ2h0TWFza1JlY3Qud2lkdGgpXG4gICAgICAuYXR0cigneCcsIE1hdGgucm91bmQocmlnaHRNYXNrUmVjdC54KSk7XG4gIH1cblxuICBwcml2YXRlIGdldExlZnRNYXNrUmVjdCgpOiBSZWN0IHtcbiAgICBjb25zdCBpbWdCb3VuZHMgPSBuZXcgT3BlblNlYWRyYWdvbi5SZWN0KFxuICAgICAgdGhpcy5jYW52YXNHcm91cFJlY3QueCxcbiAgICAgIHRoaXMuY2FudmFzR3JvdXBSZWN0LnksXG4gICAgICB0aGlzLmNhbnZhc0dyb3VwUmVjdC53aWR0aCxcbiAgICAgIHRoaXMuY2FudmFzR3JvdXBSZWN0LmhlaWdodFxuICAgICk7XG4gICAgY29uc3QgdG9wTGVmdCA9IHRoaXMudmlld2VyLnZpZXdwb3J0LnZpZXdwb3J0VG9WaWV3ZXJFbGVtZW50Q29vcmRpbmF0ZXMoXG4gICAgICBpbWdCb3VuZHMuZ2V0VG9wTGVmdCgpXG4gICAgKTtcbiAgICBsZXQgd2lkdGggPSB0b3BMZWZ0LnggLSBWaWV3ZXJPcHRpb25zLm92ZXJsYXlzLmNhbnZhc0dyb3VwTWFyZ2luSW5QYWdlVmlldztcblxuICAgIGlmICh3aWR0aCA8IDApIHtcbiAgICAgIHdpZHRoID0gMDtcbiAgICB9XG5cbiAgICByZXR1cm4gbmV3IFJlY3Qoe1xuICAgICAgeDogMCxcbiAgICAgIHdpZHRoOiB3aWR0aFxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRSaWdodE1hc2tSZWN0KCk6IFJlY3Qge1xuICAgIGNvbnN0IGltZ0JvdW5kcyA9IG5ldyBPcGVuU2VhZHJhZ29uLlJlY3QoXG4gICAgICB0aGlzLmNhbnZhc0dyb3VwUmVjdC54LFxuICAgICAgdGhpcy5jYW52YXNHcm91cFJlY3QueSxcbiAgICAgIHRoaXMuY2FudmFzR3JvdXBSZWN0LndpZHRoLFxuICAgICAgdGhpcy5jYW52YXNHcm91cFJlY3QuaGVpZ2h0XG4gICAgKTtcbiAgICBjb25zdCB0b3BSaWdodCA9IHRoaXMudmlld2VyLnZpZXdwb3J0LnZpZXdwb3J0VG9WaWV3ZXJFbGVtZW50Q29vcmRpbmF0ZXMoXG4gICAgICBpbWdCb3VuZHMuZ2V0VG9wUmlnaHQoKVxuICAgICk7XG4gICAgbGV0IHdpZHRoID0gdGhpcy52aWV3ZXIudmlld3BvcnQuX2NvbnRhaW5lcklubmVyU2l6ZS54IC0gdG9wUmlnaHQueDtcbiAgICBjb25zdCB4ID1cbiAgICAgIHRoaXMudmlld2VyLnZpZXdwb3J0Ll9jb250YWluZXJJbm5lclNpemUueCAtXG4gICAgICB3aWR0aCArXG4gICAgICBWaWV3ZXJPcHRpb25zLm92ZXJsYXlzLmNhbnZhc0dyb3VwTWFyZ2luSW5QYWdlVmlldztcblxuICAgIGlmICh3aWR0aCA8IDApIHtcbiAgICAgIHdpZHRoID0gMDtcbiAgICB9XG5cbiAgICByZXR1cm4gbmV3IFJlY3Qoe1xuICAgICAgeDogeCxcbiAgICAgIHdpZHRoOiB3aWR0aFxuICAgIH0pO1xuICB9XG59XG4iXX0=