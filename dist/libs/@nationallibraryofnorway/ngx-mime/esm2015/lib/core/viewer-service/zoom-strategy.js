import * as d3 from 'd3';
import * as OpenSeadragon from 'openseadragon';
import { Dimensions } from '../models/dimensions';
import { ViewerLayout } from '../models/viewer-layout';
import { ViewerMode } from '../models/viewer-mode';
import { ViewerOptions } from '../models/viewer-options';
import { Utils } from '../utils';
import { ZoomUtils } from './zoom-utils';
export class ZoomStrategy {
    constructor(viewer, canvasService, modeService, viewerLayoutService) {
        this.viewer = viewer;
        this.canvasService = canvasService;
        this.modeService = modeService;
        this.viewerLayoutService = viewerLayoutService;
    }
    setMinZoom(mode) {
        this.viewer.viewport.minZoomLevel = this.getHomeZoomLevel(mode);
    }
    getMinZoom() {
        return Utils.shortenDecimals(this.viewer.viewport.getMinZoom(), 5);
    }
    getMaxZoom() {
        return Utils.shortenDecimals(this.viewer.viewport.getMaxZoom(), 5);
    }
    getZoom() {
        return Utils.shortenDecimals(this.viewer.viewport.getZoom(true), 5);
    }
    goToHomeZoom() {
        this.zoomTo(this.getHomeZoomLevel(this.modeService.mode));
        if (this.modeService.isPageZoomed()) {
            this.modeService.mode = ViewerMode.PAGE;
        }
    }
    zoomTo(level, position) {
        this.viewer.viewport.zoomTo(level, position);
    }
    getHomeZoomLevel(mode) {
        if (!this.viewer || !this.canvasService) {
            return 1;
        }
        let canvasGroupHeight;
        let canvasGroupWidth;
        let viewportBounds;
        if (mode === ViewerMode.DASHBOARD) {
            canvasGroupHeight = this.canvasService.getMaxHeight();
            canvasGroupWidth = this.canvasService.getMaxWidth();
            viewportBounds = this.getDashboardViewportBounds();
        }
        else {
            const currentCanvasGroupRect = this.canvasService.getCurrentCanvasGroupRect();
            canvasGroupHeight = currentCanvasGroupRect.height;
            canvasGroupWidth = currentCanvasGroupRect.width;
            viewportBounds = this.viewer.viewport.getBounds();
        }
        return this.getFittedZoomLevel(viewportBounds, canvasGroupHeight, canvasGroupWidth);
    }
    zoomIn(zoomFactor, position) {
        if (!zoomFactor) {
            zoomFactor = ViewerOptions.zoom.zoomFactor;
        }
        if (position) {
            position = this.viewer.viewport.pointFromPixel(position);
            if (position) {
                position = ZoomUtils.constrainPositionToCanvasGroup(position, this.canvasService.getCurrentCanvasGroupRect());
            }
        }
        if (this.modeService.mode !== ViewerMode.PAGE_ZOOMED) {
            this.modeService.mode = ViewerMode.PAGE_ZOOMED;
        }
        this.zoomBy(zoomFactor, position);
    }
    zoomOut(zoomFactor, position) {
        if (!zoomFactor) {
            zoomFactor = Math.pow(ViewerOptions.zoom.zoomFactor, -1);
        }
        if (position) {
            position = this.viewer.viewport.pointFromPixel(position);
            if (position) {
                position = ZoomUtils.constrainPositionToCanvasGroup(position, this.canvasService.getCurrentCanvasGroupRect());
            }
        }
        if (this.isViewportLargerThanCanvasGroup()) {
            this.modeService.mode = ViewerMode.PAGE;
        }
        else {
            this.zoomBy(zoomFactor, position);
        }
    }
    getDashboardViewportBounds() {
        if (!this.viewer) {
            return;
        }
        const homeZoomFactor = this.getHomeZoomFactor();
        const maxViewportDimensions = new Dimensions(d3
            .select(this.viewer.container.parentNode.parentNode)
            .node()
            .getBoundingClientRect());
        const viewportHeight = maxViewportDimensions.height -
            ViewerOptions.padding.header -
            ViewerOptions.padding.footer;
        const viewportWidth = maxViewportDimensions.width * homeZoomFactor;
        const viewportSizeInViewportCoordinates = this.viewer.viewport.deltaPointsFromPixels(new OpenSeadragon.Point(viewportWidth, viewportHeight));
        return new OpenSeadragon.Rect(0, 0, viewportSizeInViewportCoordinates.x, viewportSizeInViewportCoordinates.y);
    }
    getFittedZoomLevel(viewportBounds, canvasGroupHeight, canvasGroupWidth) {
        const currentZoom = this.viewer.viewport.getZoom();
        const resizeRatio = viewportBounds.height / canvasGroupHeight;
        if (resizeRatio * canvasGroupWidth <= viewportBounds.width) {
            return Utils.shortenDecimals(resizeRatio * currentZoom, 5);
        }
        else {
            // Canvas group at full height is wider than viewport.  Return fit by width instead.
            return Utils.shortenDecimals((viewportBounds.width / canvasGroupWidth) * currentZoom, 5);
        }
    }
    zoomBy(zoomFactor, position) {
        const currentZoom = this.viewer.viewport.getZoom(false);
        zoomFactor = ZoomUtils.constraintZoomFactor(zoomFactor, currentZoom, this.getMaxZoom());
        this.viewer.viewport.zoomBy(zoomFactor, position);
    }
    isViewportLargerThanCanvasGroup() {
        const canvasGroupRec = this.canvasService.getCurrentCanvasGroupRect();
        const viewportBounds = this.viewer.viewport.getBounds();
        const pbWidth = Math.round(canvasGroupRec.width);
        const pbHeight = Math.round(canvasGroupRec.height);
        const vpWidth = Math.round(viewportBounds.width);
        const vpHeight = Math.round(viewportBounds.height);
        return vpHeight >= pbHeight || vpWidth >= pbWidth;
    }
    getHomeZoomFactor() {
        return this.modeService.mode === ViewerMode.DASHBOARD
            ? this.getDashboardZoomHomeFactor()
            : 1;
    }
    getDashboardZoomHomeFactor() {
        return this.viewerLayoutService.layout === ViewerLayout.ONE_PAGE
            ? 0.85
            : 0.66;
    }
}
export class DefaultZoomStrategy extends ZoomStrategy {
    constructor(viewer, canvasService, modeService, viewerLayoutService) {
        super(viewer, canvasService, modeService, viewerLayoutService);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiem9vbS1zdHJhdGVneS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL2xpYnMvbmd4LW1pbWUvc3JjL2xpYi9jb3JlL3ZpZXdlci1zZXJ2aWNlL3pvb20tc3RyYXRlZ3kudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLEVBQUUsTUFBTSxJQUFJLENBQUM7QUFDekIsT0FBTyxLQUFLLGFBQWEsTUFBTSxlQUFlLENBQUM7QUFHL0MsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBR2xELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUN2RCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDbkQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQ3pELE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFFakMsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQW9CekMsTUFBTSxPQUFPLFlBQVk7SUFDdkIsWUFDWSxNQUFXLEVBQ1gsYUFBNEIsRUFDNUIsV0FBd0IsRUFDeEIsbUJBQXdDO1FBSHhDLFdBQU0sR0FBTixNQUFNLENBQUs7UUFDWCxrQkFBYSxHQUFiLGFBQWEsQ0FBZTtRQUM1QixnQkFBVyxHQUFYLFdBQVcsQ0FBYTtRQUN4Qix3QkFBbUIsR0FBbkIsbUJBQW1CLENBQXFCO0lBQ2pELENBQUM7SUFFSixVQUFVLENBQUMsSUFBZ0I7UUFDekIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNsRSxDQUFDO0lBRUQsVUFBVTtRQUNSLE9BQU8sS0FBSyxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxVQUFVLEVBQUUsRUFBRSxDQUFD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QWEsRUFBRSxXQUFXLEVBQUUsbUJBQW1CLENBQUMsQ0FBQztJQUNqRSxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBkMyBmcm9tICdkMyc7XG5pbXBvcnQgKiBhcyBPcGVuU2VhZHJhZ29uIGZyb20gJ29wZW5zZWFkcmFnb24nO1xuaW1wb3J0IHsgQ2FudmFzU2VydmljZSB9IGZyb20gJy4uL2NhbnZhcy1zZXJ2aWNlL2NhbnZhcy1zZXJ2aWNlJztcbmltcG9ydCB7IE1vZGVTZXJ2aWNlIH0gZnJvbSAnLi4vbW9kZS1zZXJ2aWNlL21vZGUuc2VydmljZSc7XG5pbXBvcnQgeyBEaW1lbnNpb25zIH0gZnJvbSAnLi4vbW9kZWxzL2RpbWVuc2lvbnMnO1xuaW1wb3J0IHsgRGlyZWN0aW9uIH0gZnJvbSAnLi4vbW9kZWxzL2RpcmVjdGlvbic7XG5pbXBvcnQgeyBQb2ludCB9IGZyb20gJy4uL21vZGVscy9wb2ludCc7XG5pbXBvcnQgeyBWaWV3ZXJMYXlvdXQgfSBmcm9tICcuLi9tb2RlbHMvdmlld2VyLWxheW91dCc7XG5pbXBvcnQgeyBWaWV3ZXJNb2RlIH0gZnJvbSAnLi4vbW9kZWxzL3ZpZXdlci1tb2RlJztcbmltcG9ydCB7IFZpZXdlck9wdGlvbnMgfSBmcm9tICcuLi9tb2RlbHMvdmlld2VyLW9wdGlvbnMnO1xuaW1wb3J0IHsgVXRpbHMgfSBmcm9tICcuLi91dGlscyc7XG5pbXBvcnQgeyBWaWV3ZXJMYXlvdXRTZXJ2aWNlIH0gZnJvbSAnLi4vdmlld2VyLWxheW91dC1zZXJ2aWNlL3ZpZXdlci1sYXlvdXQtc2VydmljZSc7XG5pbXBvcnQgeyBab29tVXRpbHMgfSBmcm9tICcuL3pvb20tdXRpbHMnO1xuXG5leHBvcnQgaW50ZXJmYWNlIENhbnZhc0dyb3VwIHtcbiAgY2FudmFzR3JvdXBJbmRleDogbnVtYmVyO1xuICBjYW52YXNHcm91cEVuZEhpdENvdW50UmVhY2hlZD86IGJvb2xlYW47XG4gIGRpcmVjdGlvbjogRGlyZWN0aW9uO1xuICBpbW1lZGlhdGVseTogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBTdHJhdGVneSB7XG4gIHNldE1pblpvb20obW9kZTogVmlld2VyTW9kZSk6IHZvaWQ7XG4gIGdldE1pblpvb20oKTogbnVtYmVyO1xuICBnZXRNYXhab29tKCk6IG51bWJlcjtcbiAgZ2V0Wm9vbSgpOiBudW1iZXI7XG4gIGdvVG9Ib21lWm9vbSgpOiB2b2lkO1xuICB6b29tVG8obGV2ZWw6IG51bWJlciwgcG9zaXRpb24/OiBQb2ludCk6IHZvaWQ7XG4gIHpvb21Jbih6b29tRmFjdG9yPzogbnVtYmVyLCBwb3NpdGlvbj86IFBvaW50KTogdm9pZDtcbiAgem9vbU91dCh6b29tRmFjdG9yPzogbnVtYmVyLCBwb3NpdGlvbj86IFBvaW50KTogdm9pZDtcbn1cblxuZXhwb3J0IGNsYXNzIFpvb21TdHJhdGVneSB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHByb3RlY3RlZCB2aWV3ZXI6IGFueSxcbiAgICBwcm90ZWN0ZWQgY2FudmFzU2VydmljZTogQ2FudmFzU2VydmljZSxcbiAgICBwcm90ZWN0ZWQgbW9kZVNlcnZpY2U6IE1vZGVTZXJ2aWNlLFxuICAgIHByb3RlY3RlZCB2aWV3ZXJMYXlvdXRTZXJ2aWNlOiBWaWV3ZXJMYXlvdXRTZXJ2aWNlXG4gICkge31cblxuICBzZXRNaW5ab29tKG1vZGU6IFZpZXdlck1vZGUpOiB2b2lkIHtcbiAgICB0aGlzLnZpZXdlci52aWV3cG9ydC5taW5ab29tTGV2ZWwgPSB0aGlzLmdldEhvbWVab29tTGV2ZWwobW9kZSk7XG4gIH1cblxuICBnZXRNaW5ab29tKCk6IG51bWJlciB7XG4gICAgcmV0dXJuIFV0aWxzLnNob3J0ZW5EZWNpbWFscyh0aGlzLnZpZXdlci52aWV3cG9ydC5nZXRNaW5ab29tKCksIDUpO1xuICB9XG5cbiAgZ2V0TWF4Wm9vbSgpOiBudW1iZXIge1xuICAgIHJldHVybiBVdGlscy5zaG9ydGVuRGVjaW1hbHModGhpcy52aWV3ZXIudmlld3BvcnQuZ2V0TWF4Wm9vbSgpLCA1KTtcbiAgfVxuXG4gIGdldFpvb20oKTogbnVtYmVyIHtcbiAgICByZXR1cm4gVXRpbHMuc2hvcnRlbkRlY2ltYWxzKHRoaXMudmlld2VyLnZpZXdwb3J0LmdldFpvb20odHJ1ZSksIDUpO1xuICB9XG5cbiAgZ29Ub0hvbWVab29tKCk6IHZvaWQge1xuICAgIHRoaXMuem9vbVRvKHRoaXMuZ2V0SG9tZVpvb21MZXZlbCh0aGlzLm1vZGVTZXJ2aWNlLm1vZGUpKTtcbiAgICBpZiAodGhpcy5tb2RlU2VydmljZS5pc1BhZ2Vab29tZWQoKSkge1xuICAgICAgdGhpcy5tb2RlU2VydmljZS5tb2RlID0gVmlld2VyTW9kZS5QQUdFO1xuICAgIH1cbiAgfVxuXG4gIHpvb21UbyhsZXZlbDogbnVtYmVyLCBwb3NpdGlvbj86IFBvaW50KTogdm9pZCB7XG4gICAgdGhpcy52aWV3ZXIudmlld3BvcnQuem9vbVRvKGxldmVsLCBwb3NpdGlvbik7XG4gIH1cblxuICBwcml2YXRlIGdldEhvbWVab29tTGV2ZWwobW9kZTogVmlld2VyTW9kZSk6IG51bWJlciB7XG4gICAgaWYgKCF0aGlzLnZpZXdlciB8fCAhdGhpcy5jYW52YXNTZXJ2aWNlKSB7XG4gICAgICByZXR1cm4gMTtcbiAgICB9XG5cbiAgICBsZXQgY2FudmFzR3JvdXBIZWlnaHQ6IG51bWJlcjtcbiAgICBsZXQgY2FudmFzR3JvdXBXaWR0aDogbnVtYmVyO1xuICAgIGxldCB2aWV3cG9ydEJvdW5kczogYW55O1xuXG4gICAgaWYgKG1vZGUgPT09IFZpZXdlck1vZGUuREFTSEJPQVJEKSB7XG4gICAgICBjYW52YXNHcm91cEhlaWdodCA9IHRoaXMuY2FudmFzU2VydmljZS5nZXRNYXhIZWlnaHQoKTtcbiAgICAgIGNhbnZhc0dyb3VwV2lkdGggPSB0aGlzLmNhbnZhc1NlcnZpY2UuZ2V0TWF4V2lkdGgoKTtcbiAgICAgIHZpZXdwb3J0Qm91bmRzID0gdGhpcy5nZXREYXNoYm9hcmRWaWV3cG9ydEJvdW5kcygpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBjdXJyZW50Q2FudmFzR3JvdXBSZWN0ID0gdGhpcy5jYW52YXNTZXJ2aWNlLmdldEN1cnJlbnRDYW52YXNHcm91cFJlY3QoKTtcbiAgICAgIGNhbnZhc0dyb3VwSGVpZ2h0ID0gY3VycmVudENhbnZhc0dyb3VwUmVjdC5oZWlnaHQ7XG4gICAgICBjYW52YXNHcm91cFdpZHRoID0gY3VycmVudENhbnZhc0dyb3VwUmVjdC53aWR0aDtcbiAgICAgIHZpZXdwb3J0Qm91bmRzID0gdGhpcy52aWV3ZXIudmlld3BvcnQuZ2V0Qm91bmRzKCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuZ2V0Rml0dGVkWm9vbUxldmVsKFxuICAgICAgdmlld3BvcnRCb3VuZHMsXG4gICAgICBjYW52YXNHcm91cEhlaWdodCxcbiAgICAgIGNhbnZhc0dyb3VwV2lkdGhcbiAgICApO1xuICB9XG5cbiAgem9vbUluKHpvb21GYWN0b3I/OiBudW1iZXIsIHBvc2l0aW9uPzogUG9pbnQpOiB2b2lkIHtcbiAgICBpZiAoIXpvb21GYWN0b3IpIHtcbiAgICAgIHpvb21GYWN0b3IgPSBWaWV3ZXJPcHRpb25zLnpvb20uem9vbUZhY3RvcjtcbiAgICB9XG5cbiAgICBpZiAocG9zaXRpb24pIHtcbiAgICAgIHBvc2l0aW9uID0gdGhpcy52aWV3ZXIudmlld3BvcnQucG9pbnRGcm9tUGl4ZWwocG9zaXRpb24pO1xuICAgICAgaWYgKHBvc2l0aW9uKSB7XG4gICAgICAgIHBvc2l0aW9uID0gWm9vbVV0aWxzLmNvbnN0cmFpblBvc2l0aW9uVG9DYW52YXNHcm91cChcbiAgICAgICAgICBwb3NpdGlvbixcbiAgICAgICAgICB0aGlzLmNhbnZhc1NlcnZpY2UuZ2V0Q3VycmVudENhbnZhc0dyb3VwUmVjdCgpXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKHRoaXMubW9kZVNlcnZpY2UubW9kZSAhPT0gVmlld2VyTW9kZS5QQUdFX1pPT01FRCkge1xuICAgICAgdGhpcy5tb2RlU2VydmljZS5tb2RlID0gVmlld2VyTW9kZS5QQUdFX1pPT01FRDtcbiAgICB9XG5cbiAgICB0aGlzLnpvb21CeSh6b29tRmFjdG9yLCBwb3NpdGlvbik7XG4gIH1cblxuICB6b29tT3V0KHpvb21GYWN0b3I/OiBudW1iZXIsIHBvc2l0aW9uPzogUG9pbnQpOiB2b2lkIHtcbiAgICBpZiAoIXpvb21GYWN0b3IpIHtcbiAgICAgIHpvb21GYWN0b3IgPSBNYXRoLnBvdyhWaWV3ZXJPcHRpb25zLnpvb20uem9vbUZhY3RvciwgLTEpO1xuICAgIH1cblxuICAgIGlmIChwb3NpdGlvbikge1xuICAgICAgcG9zaXRpb24gPSB0aGlzLnZpZXdlci52aWV3cG9ydC5wb2ludEZyb21QaXhlbChwb3NpdGlvbik7XG4gICAgICBpZiAocG9zaXRpb24pIHtcbiAgICAgICAgcG9zaXRpb24gPSBab29tVXRpbHMuY29uc3RyYWluUG9zaXRpb25Ub0NhbnZhc0dyb3VwKFxuICAgICAgICAgIHBvc2l0aW9uLFxuICAgICAgICAgIHRoaXMuY2FudmFzU2VydmljZS5nZXRDdXJyZW50Q2FudmFzR3JvdXBSZWN0KClcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAodGhpcy5pc1ZpZXdwb3J0TGFyZ2VyVGhhbkNhbnZhc0dyb3VwKCkpIHtcbiAgICAgIHRoaXMubW9kZVNlcnZpY2UubW9kZSA9IFZpZXdlck1vZGUuUEFHRTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy56b29tQnkoem9vbUZhY3RvciwgcG9zaXRpb24pO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZ2V0RGFzaGJvYXJkVmlld3BvcnRCb3VuZHMoKTogYW55IHtcbiAgICBpZiAoIXRoaXMudmlld2VyKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgaG9tZVpvb21GYWN0b3IgPSB0aGlzLmdldEhvbWVab29tRmFjdG9yKCk7XG4gICAgY29uc3QgbWF4Vmlld3BvcnREaW1lbnNpb25zID0gbmV3IERpbWVuc2lvbnMoXG4gICAgICBkM1xuICAgICAgICAuc2VsZWN0KHRoaXMudmlld2VyLmNvbnRhaW5lci5wYXJlbnROb2RlLnBhcmVudE5vZGUpXG4gICAgICAgIC5ub2RlKClcbiAgICAgICAgLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpXG4gICAgKTtcbiAgICBjb25zdCB2aWV3cG9ydEhlaWdodCA9XG4gICAgICBtYXhWaWV3cG9ydERpbWVuc2lvbnMuaGVpZ2h0IC1cbiAgICAgIFZpZXdlck9wdGlvbnMucGFkZGluZy5oZWFkZXIgLVxuICAgICAgVmlld2VyT3B0aW9ucy5wYWRkaW5nLmZvb3RlcjtcbiAgICBjb25zdCB2aWV3cG9ydFdpZHRoID0gbWF4Vmlld3BvcnREaW1lbnNpb25zLndpZHRoICogaG9tZVpvb21GYWN0b3I7XG5cbiAgICBjb25zdCB2aWV3cG9ydFNpemVJblZpZXdwb3J0Q29vcmRpbmF0ZXMgPSB0aGlzLnZpZXdlci52aWV3cG9ydC5kZWx0YVBvaW50c0Zyb21QaXhlbHMoXG4gICAgICBuZXcgT3BlblNlYWRyYWdvbi5Qb2ludCh2aWV3cG9ydFdpZHRoLCB2aWV3cG9ydEhlaWdodClcbiAgICApO1xuXG4gICAgcmV0dXJuIG5ldyBPcGVuU2VhZHJhZ29uLlJlY3QoXG4gICAgICAwLFxuICAgICAgMCxcbiAgICAgIHZpZXdwb3J0U2l6ZUluVmlld3BvcnRDb29yZGluYXRlcy54LFxuICAgICAgdmlld3BvcnRTaXplSW5WaWV3cG9ydENvb3JkaW5hdGVzLnlcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRGaXR0ZWRab29tTGV2ZWwoXG4gICAgdmlld3BvcnRCb3VuZHM6IGFueSxcbiAgICBjYW52YXNHcm91cEhlaWdodDogbnVtYmVyLFxuICAgIGNhbnZhc0dyb3VwV2lkdGg6IG51bWJlclxuICApIHtcbiAgICBjb25zdCBjdXJyZW50Wm9vbTogbnVtYmVyID0gdGhpcy52aWV3ZXIudmlld3BvcnQuZ2V0Wm9vbSgpO1xuICAgIGNvbnN0IHJlc2l6ZVJhdGlvOiBudW1iZXIgPSB2aWV3cG9ydEJvdW5kcy5oZWlnaHQgLyBjYW52YXNHcm91cEhlaWdodDtcblxuICAgIGlmIChyZXNpemVSYXRpbyAqIGNhbnZhc0dyb3VwV2lkdGggPD0gdmlld3BvcnRCb3VuZHMud2lkdGgpIHtcbiAgICAgIHJldHVybiBVdGlscy5zaG9ydGVuRGVjaW1hbHMocmVzaXplUmF0aW8gKiBjdXJyZW50Wm9vbSwgNSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIENhbnZhcyBncm91cCBhdCBmdWxsIGhlaWdodCBpcyB3aWRlciB0aGFuIHZpZXdwb3J0LiAgUmV0dXJuIGZpdCBieSB3aWR0aCBpbnN0ZWFkLlxuICAgICAgcmV0dXJuIFV0aWxzLnNob3J0ZW5EZWNpbWFscyhcbiAgICAgICAgKHZpZXdwb3J0Qm91bmRzLndpZHRoIC8gY2FudmFzR3JvdXBXaWR0aCkgKiBjdXJyZW50Wm9vbSxcbiAgICAgICAgNVxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHpvb21CeSh6b29tRmFjdG9yOiBudW1iZXIsIHBvc2l0aW9uPzogUG9pbnQpOiB2b2lkIHtcbiAgICBjb25zdCBjdXJyZW50Wm9vbSA9IHRoaXMudmlld2VyLnZpZXdwb3J0LmdldFpvb20oZmFsc2UpO1xuICAgIHpvb21GYWN0b3IgPSBab29tVXRpbHMuY29uc3RyYWludFpvb21GYWN0b3IoXG4gICAgICB6b29tRmFjdG9yLFxuICAgICAgY3VycmVudFpvb20sXG4gICAgICB0aGlzLmdldE1heFpvb20oKVxuICAgICk7XG4gICAgdGhpcy52aWV3ZXIudmlld3BvcnQuem9vbUJ5KHpvb21GYWN0b3IsIHBvc2l0aW9uKTtcbiAgfVxuXG4gIHByaXZhdGUgaXNWaWV3cG9ydExhcmdlclRoYW5DYW52YXNHcm91cCgpOiBib29sZWFuIHtcbiAgICBjb25zdCBjYW52YXNHcm91cFJlYyA9IHRoaXMuY2FudmFzU2VydmljZS5nZXRDdXJyZW50Q2FudmFzR3JvdXBSZWN0KCk7XG4gICAgY29uc3Qgdmlld3BvcnRCb3VuZHMgPSB0aGlzLnZpZXdlci52aWV3cG9ydC5nZXRCb3VuZHMoKTtcbiAgICBjb25zdCBwYldpZHRoID0gTWF0aC5yb3VuZChjYW52YXNHcm91cFJlYy53aWR0aCk7XG4gICAgY29uc3QgcGJIZWlnaHQgPSBNYXRoLnJvdW5kKGNhbnZhc0dyb3VwUmVjLmhlaWdodCk7XG4gICAgY29uc3QgdnBXaWR0aCA9IE1hdGgucm91bmQodmlld3BvcnRCb3VuZHMud2lkdGgpO1xuICAgIGNvbnN0IHZwSGVpZ2h0ID0gTWF0aC5yb3VuZCh2aWV3cG9ydEJvdW5kcy5oZWlnaHQpO1xuICAgIHJldHVybiB2cEhlaWdodCA+PSBwYkhlaWdodCB8fCB2cFdpZHRoID49IHBiV2lkdGg7XG4gIH1cblxuICBwcml2YXRlIGdldEhvbWVab29tRmFjdG9yKCkge1xuICAgIHJldHVybiB0aGlzLm1vZGVTZXJ2aWNlLm1vZGUgPT09IFZpZXdlck1vZGUuREFTSEJPQVJEXG4gICAgICA/IHRoaXMuZ2V0RGFzaGJvYXJkWm9vbUhvbWVGYWN0b3IoKVxuICAgICAgOiAxO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXREYXNoYm9hcmRab29tSG9tZUZhY3RvcigpIHtcbiAgICByZXR1cm4gdGhpcy52aWV3ZXJMYXlvdXRTZXJ2aWNlLmxheW91dCA9PT0gVmlld2VyTGF5b3V0Lk9ORV9QQUdFXG4gICAgICA/IDAuODVcbiAgICAgIDogMC42NjtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgRGVmYXVsdFpvb21TdHJhdGVneSBleHRlbmRzIFpvb21TdHJhdGVneSBpbXBsZW1lbnRzIFN0cmF0ZWd5IHtcbiAgY29uc3RydWN0b3IoXG4gICAgdmlld2VyOiBhbnksXG4gICAgY2FudmFzU2VydmljZTogQ2FudmFzU2VydmljZSxcbiAgICBtb2RlU2VydmljZTogTW9kZVNlcnZpY2UsXG4gICAgdmlld2VyTGF5b3V0U2VydmljZTogVmlld2VyTGF5b3V0U2VydmljZVxuICApIHtcbiAgICBzdXBlcih2aWV3ZXIsIGNhbnZhc1NlcnZpY2UsIG1vZGVTZXJ2aWNlLCB2aWV3ZXJMYXlvdXRTZXJ2aWNlKTtcbiAgfVxufVxuIl19