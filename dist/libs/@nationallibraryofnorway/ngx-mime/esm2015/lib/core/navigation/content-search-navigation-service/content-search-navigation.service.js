import { __decorate } from "tslib";
import { Injectable } from '@angular/core';
import { CanvasService } from '../../canvas-service/canvas-service';
import { IiifContentSearchService } from '../../iiif-content-search-service/iiif-content-search.service';
let ContentSearchNavigationService = class ContentSearchNavigationService {
    constructor(canvasService, iiifContentSearchService) {
        this.canvasService = canvasService;
        this.iiifContentSearchService = iiifContentSearchService;
        this.currentIndex = 0;
        this.isHitOnActiveCanvasGroup = false;
        this._isFirstHitOnCanvasGroup = false;
        this._isLastHitOnCanvasGroup = false;
        this.canvasesPerCanvasGroup = [-1];
        this.iiifContentSearchService.onChange.subscribe((result) => {
            this.searchResult = result;
        });
    }
    update(canvasGroupIndex) {
        this.canvasesPerCanvasGroup = this.canvasService.getCanvasesPerCanvasGroup(canvasGroupIndex);
        this.currentIndex = this.findCurrentHitIndex(this.canvasesPerCanvasGroup);
        this.isHitOnActiveCanvasGroup = this.findHitOnActiveCanvasGroup();
        this._isFirstHitOnCanvasGroup = this.isFirstHitOnCanvasGroup();
        this._isLastHitOnCanvasGroup = this.findLastHitOnCanvasGroup();
    }
    getCurrentIndex() {
        return this.currentIndex;
    }
    getHitOnActiveCanvasGroup() {
        return this.isHitOnActiveCanvasGroup;
    }
    getFirstHitCanvasGroup() {
        return this._isFirstHitOnCanvasGroup;
    }
    getLastHitCanvasGroup() {
        return this._isLastHitOnCanvasGroup;
    }
    goToNextCanvasGroupHit() {
        if (!this._isLastHitOnCanvasGroup) {
            let nextHit;
            if (this.currentIndex === -1) {
                nextHit = this.searchResult.get(0);
            }
            else {
                const current = this.searchResult.get(this.currentIndex);
                const canvasGroup = this.canvasService.findCanvasGroupByCanvasIndex(current.index);
                const canvasesPerCanvasGroup = this.canvasService.getCanvasesPerCanvasGroup(canvasGroup);
                const lastCanvasGroupIndex = this.getLastCanvasGroupIndex(canvasesPerCanvasGroup);
                nextHit = this.searchResult.hits.find(h => h.index > lastCanvasGroupIndex);
            }
            if (nextHit) {
                this.goToCanvasIndex(nextHit);
            }
        }
    }
    goToPreviousCanvasGroupHit() {
        const previousIndex = this.isHitOnActiveCanvasGroup
            ? this.currentIndex - 1
            : this.currentIndex;
        const previousHit = this.findFirstHitOnCanvasGroup(previousIndex);
        this.goToCanvasIndex(previousHit);
    }
    goToCanvasIndex(hit) {
        this.currentIndex = this.findCurrentHitIndex([hit.index]);
        this.iiifContentSearchService.selected(hit);
    }
    findLastHitOnCanvasGroup() {
        const lastCanvasIndex = this.searchResult.get(this.searchResult.size() - 1)
            .index;
        const currentHit = this.searchResult.get(this.currentIndex);
        return currentHit.index === lastCanvasIndex;
    }
    findFirstHitOnCanvasGroup(previousIndex) {
        let previousHit = this.searchResult.get(previousIndex);
        const canvasGroupIndex = this.canvasService.findCanvasGroupByCanvasIndex(previousHit.index);
        const canvasesPerCanvasGroup = this.canvasService.getCanvasesPerCanvasGroup(canvasGroupIndex);
        const leftCanvas = canvasesPerCanvasGroup[0];
        const leftCanvasHit = this.searchResult.hits.find(h => h.index === leftCanvas);
        if (leftCanvasHit) {
            previousHit = leftCanvasHit;
        }
        else if (canvasesPerCanvasGroup.length === 2) {
            const rightCanvas = canvasesPerCanvasGroup[1];
            previousHit = this.searchResult.hits.find(h => h.index === rightCanvas);
        }
        return previousHit;
    }
    findHitOnActiveCanvasGroup() {
        return (this.canvasesPerCanvasGroup.indexOf(this.searchResult.get(this.currentIndex).index) >= 0);
    }
    findCurrentHitIndex(canvasGroupIndexes) {
        for (let i = 0; i < this.searchResult.size(); i++) {
            const hit = this.searchResult.get(i);
            if (canvasGroupIndexes.indexOf(hit.index) >= 0) {
                return i;
            }
            if (hit.index >= canvasGroupIndexes[canvasGroupIndexes.length - 1]) {
                if (i === 0) {
                    return -1;
                }
                else {
                    const phit = this.searchResult.get(i - 1);
                    return this.searchResult.hits.findIndex(sr => sr.index === phit.index);
                }
            }
        }
        return this.searchResult.size() - 1;
    }
    isFirstHitOnCanvasGroup() {
        return this.currentIndex <= 0;
    }
    getLastCanvasGroupIndex(canvasesPerCanvasGroup) {
        return canvasesPerCanvasGroup.length === 1
            ? canvasesPerCanvasGroup[0]
            : canvasesPerCanvasGroup[1];
    }
};
ContentSearchNavigationService.ctorParameters = () => [
    { type: CanvasService },
    { type: IiifContentSearchService }
];
ContentSearchNavigationService = __decorate([
    Injectable()
], ContentSearchNavigationService);
export { ContentSearchNavigationService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udGVudC1zZWFyY2gtbmF2aWdhdGlvbi5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQG5hdGlvbmFsbGlicmFyeW9mbm9yd2F5L25neC1taW1lLyIsInNvdXJjZXMiOlsibGliL2NvcmUvbmF2aWdhdGlvbi9jb250ZW50LXNlYXJjaC1uYXZpZ2F0aW9uLXNlcnZpY2UvY29udGVudC1zZWFyY2gtbmF2aWdhdGlvbi5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRTNDLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxxQ0FBcUMsQ0FBQztBQUNwRSxPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSwrREFBK0QsQ0FBQztBQUt6RyxJQUFhLDhCQUE4QixHQUEzQyxNQUFhLDhCQUE4QjtJQVF6QyxZQUNVLGFBQTRCLEVBQzVCLHdCQUFrRDtRQURsRCxrQkFBYSxHQUFiLGFBQWEsQ0FBZTtRQUM1Qiw2QkFBd0IsR0FBeEIsd0JBQXdCLENBQTBCO1FBVHBELGlCQUFZLEdBQUcsQ0FBQyxDQUFDO1FBQ2pCLDZCQUF3QixHQUFHLEtBQUssQ0FBQztRQUNqQyw2QkFBd0IsR0FBRyxLQUFLLENBQUM7UUFDakMsNEJBQXVCLEdBQUcsS0FBSyxDQUFDO1FBQ2hDLDJCQUFzQixHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQU9wQyxJQUFJLENBQUMsd0JBQXdCLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxDQUFDLE1BQW9CLEVBQUUsRUFBRTtZQUN4RSxJQUFJLENBQUMsWUFBWSxHQUFHLE1BQU0sQ0FBQztRQUM3QixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxNQUFNLENBQUMsZ0JBQXdCO1FBQzdCLElBQUksQ0FBQyxzQkFBc0IsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLHlCQUF5QixDQUN4RSxnQkFBZ0IsQ0FDakIsQ0FBQztRQUNGLElBQUksQ0FB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QUNGLHdCQUF3Qjs7QUFWakQsOEJBQThCO0lBRDFDLFVBQVUsRUFBRTtHQUNBLDhCQUE4QixDQW1KMUM7U0FuSlksOEJBQThCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuXG5pbXBvcnQgeyBDYW52YXNTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vY2FudmFzLXNlcnZpY2UvY2FudmFzLXNlcnZpY2UnO1xuaW1wb3J0IHsgSWlpZkNvbnRlbnRTZWFyY2hTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vaWlpZi1jb250ZW50LXNlYXJjaC1zZXJ2aWNlL2lpaWYtY29udGVudC1zZWFyY2guc2VydmljZSc7XG5pbXBvcnQgeyBTZWFyY2hSZXN1bHQgfSBmcm9tICcuLi8uLi9tb2RlbHMvc2VhcmNoLXJlc3VsdCc7XG5pbXBvcnQgeyBIaXQgfSBmcm9tICcuLi8uLi9tb2RlbHMvaGl0JztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIENvbnRlbnRTZWFyY2hOYXZpZ2F0aW9uU2VydmljZSB7XG4gIHByaXZhdGUgY3VycmVudEluZGV4ID0gMDtcbiAgcHJpdmF0ZSBpc0hpdE9uQWN0aXZlQ2FudmFzR3JvdXAgPSBmYWxzZTtcbiAgcHJpdmF0ZSBfaXNGaXJzdEhpdE9uQ2FudmFzR3JvdXAgPSBmYWxzZTtcbiAgcHJpdmF0ZSBfaXNMYXN0SGl0T25DYW52YXNHcm91cCA9IGZhbHNlO1xuICBwcml2YXRlIGNhbnZhc2VzUGVyQ2FudmFzR3JvdXAgPSBbLTFdO1xuICBwcml2YXRlIHNlYXJjaFJlc3VsdDogU2VhcmNoUmVzdWx0O1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgY2FudmFzU2VydmljZTogQ2FudmFzU2VydmljZSxcbiAgICBwcml2YXRlIGlpaWZDb250ZW50U2VhcmNoU2VydmljZTogSWlpZkNvbnRlbnRTZWFyY2hTZXJ2aWNlXG4gICkge1xuICAgIHRoaXMuaWlpZkNvbnRlbnRTZWFyY2hTZXJ2aWNlLm9uQ2hhbmdlLnN1YnNjcmliZSgocmVzdWx0OiBTZWFyY2hSZXN1bHQpID0+IHtcbiAgICAgIHRoaXMuc2VhcmNoUmVzdWx0ID0gcmVzdWx0O1xuICAgIH0pO1xuICB9XG5cbiAgdXBkYXRlKGNhbnZhc0dyb3VwSW5kZXg6IG51bWJlcikge1xuICAgIHRoaXMuY2FudmFzZXNQZXJDYW52YXNHcm91cCA9IHRoaXMuY2FudmFzU2VydmljZS5nZXRDYW52YXNlc1BlckNhbnZhc0dyb3VwKFxuICAgICAgY2FudmFzR3JvdXBJbmRleFxuICAgICk7XG4gICAgdGhpcy5jdXJyZW50SW5kZXggPSB0aGlzLmZpbmRDdXJyZW50SGl0SW5kZXgodGhpcy5jYW52YXNlc1BlckNhbnZhc0dyb3VwKTtcbiAgICB0aGlzLmlzSGl0T25BY3RpdmVDYW52YXNHcm91cCA9IHRoaXMuZmluZEhpdE9uQWN0aXZlQ2FudmFzR3JvdXAoKTtcbiAgICB0aGlzLl9pc0ZpcnN0SGl0T25DYW52YXNHcm91cCA9IHRoaXMuaXNGaXJzdEhpdE9uQ2FudmFzR3JvdXAoKTtcbiAgICB0aGlzLl9pc0xhc3RIaXRPbkNhbnZhc0dyb3VwID0gdGhpcy5maW5kTGFzdEhpdE9uQ2FudmFzR3JvdXAoKTtcbiAgfVxuXG4gIGdldEN1cnJlbnRJbmRleCgpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLmN1cnJlbnRJbmRleDtcbiAgfVxuXG4gIGdldEhpdE9uQWN0aXZlQ2FudmFzR3JvdXAoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuaXNIaXRPbkFjdGl2ZUNhbnZhc0dyb3VwO1xuICB9XG5cbiAgZ2V0Rmlyc3RIaXRDYW52YXNHcm91cCgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5faXNGaXJzdEhpdE9uQ2FudmFzR3JvdXA7XG4gIH1cblxuICBnZXRMYXN0SGl0Q2FudmFzR3JvdXAoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuX2lzTGFzdEhpdE9uQ2FudmFzR3JvdXA7XG4gIH1cblxuICBnb1RvTmV4dENhbnZhc0dyb3VwSGl0KCkge1xuICAgIGlmICghdGhpcy5faXNMYXN0SGl0T25DYW52YXNHcm91cCkge1xuICAgICAgbGV0IG5leHRIaXQ6IEhpdDtcbiAgICAgIGlmICh0aGlzLmN1cnJlbnRJbmRleCA9PT0gLTEpIHtcbiAgICAgICAgbmV4dEhpdCA9IHRoaXMuc2VhcmNoUmVzdWx0LmdldCgwKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IGN1cnJlbnQgPSB0aGlzLnNlYXJjaFJlc3VsdC5nZXQodGhpcy5jdXJyZW50SW5kZXgpO1xuICAgICAgICBjb25zdCBjYW52YXNHcm91cCA9IHRoaXMuY2FudmFzU2VydmljZS5maW5kQ2FudmFzR3JvdXBCeUNhbnZhc0luZGV4KFxuICAgICAgICAgIGN1cnJlbnQuaW5kZXhcbiAgICAgICAgKTtcbiAgICAgICAgY29uc3QgY2FudmFzZXNQZXJDYW52YXNHcm91cCA9IHRoaXMuY2FudmFzU2VydmljZS5nZXRDYW52YXNlc1BlckNhbnZhc0dyb3VwKFxuICAgICAgICAgIGNhbnZhc0dyb3VwXG4gICAgICAgICk7XG4gICAgICAgIGNvbnN0IGxhc3RDYW52YXNHcm91cEluZGV4ID0gdGhpcy5nZXRMYXN0Q2FudmFzR3JvdXBJbmRleChcbiAgICAgICAgICBjYW52YXNlc1BlckNhbnZhc0dyb3VwXG4gICAgICAgICk7XG4gICAgICAgIG5leHRIaXQgPSB0aGlzLnNlYXJjaFJlc3VsdC5oaXRzLmZpbmQoXG4gICAgICAgICAgaCA9PiBoLmluZGV4ID4gbGFzdENhbnZhc0dyb3VwSW5kZXhcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIGlmIChuZXh0SGl0KSB7XG4gICAgICAgIHRoaXMuZ29Ub0NhbnZhc0luZGV4KG5leHRIaXQpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGdvVG9QcmV2aW91c0NhbnZhc0dyb3VwSGl0KCkge1xuICAgIGNvbnN0IHByZXZpb3VzSW5kZXggPSB0aGlzLmlzSGl0T25BY3RpdmVDYW52YXNHcm91cFxuICAgICAgPyB0aGlzLmN1cnJlbnRJbmRleCAtIDFcbiAgICAgIDogdGhpcy5jdXJyZW50SW5kZXg7XG4gICAgY29uc3QgcHJldmlvdXNIaXQgPSB0aGlzLmZpbmRGaXJzdEhpdE9uQ2FudmFzR3JvdXAocHJldmlvdXNJbmRleCk7XG4gICAgdGhpcy5nb1RvQ2FudmFzSW5kZXgocHJldmlvdXNIaXQpO1xuICB9XG5cbiAgcHJpdmF0ZSBnb1RvQ2FudmFzSW5kZXgoaGl0OiBIaXQpOiB2b2lkIHtcbiAgICB0aGlzLmN1cnJlbnRJbmRleCA9IHRoaXMuZmluZEN1cnJlbnRIaXRJbmRleChbaGl0LmluZGV4XSk7XG4gICAgdGhpcy5paWlmQ29udGVudFNlYXJjaFNlcnZpY2Uuc2VsZWN0ZWQoaGl0KTtcbiAgfVxuXG4gIHByaXZhdGUgZmluZExhc3RIaXRPbkNhbnZhc0dyb3VwKCkge1xuICAgIGNvbnN0IGxhc3RDYW52YXNJbmRleCA9IHRoaXMuc2VhcmNoUmVzdWx0LmdldCh0aGlzLnNlYXJjaFJlc3VsdC5zaXplKCkgLSAxKVxuICAgICAgLmluZGV4O1xuICAgIGNvbnN0IGN1cnJlbnRIaXQgPSB0aGlzLnNlYXJjaFJlc3VsdC5nZXQodGhpcy5jdXJyZW50SW5kZXgpO1xuICAgIHJldHVybiBjdXJyZW50SGl0LmluZGV4ID09PSBsYXN0Q2FudmFzSW5kZXg7XG4gIH1cblxuICBwcml2YXRlIGZpbmRGaXJzdEhpdE9uQ2FudmFzR3JvdXAocHJldmlvdXNJbmRleDogbnVtYmVyKTogSGl0IHtcbiAgICBsZXQgcHJldmlvdXNIaXQgPSB0aGlzLnNlYXJjaFJlc3VsdC5nZXQocHJldmlvdXNJbmRleCk7XG4gICAgY29uc3QgY2FudmFzR3JvdXBJbmRleCA9IHRoaXMuY2FudmFzU2VydmljZS5maW5kQ2FudmFzR3JvdXBCeUNhbnZhc0luZGV4KFxuICAgICAgcHJldmlvdXNIaXQuaW5kZXhcbiAgICApO1xuICAgIGNvbnN0IGNhbnZhc2VzUGVyQ2FudmFzR3JvdXAgPSB0aGlzLmNhbnZhc1NlcnZpY2UuZ2V0Q2FudmFzZXNQZXJDYW52YXNHcm91cChcbiAgICAgIGNhbnZhc0dyb3VwSW5kZXhcbiAgICApO1xuICAgIGNvbnN0IGxlZnRDYW52YXMgPSBjYW52YXNlc1BlckNhbnZhc0dyb3VwWzBdO1xuICAgIGNvbnN0IGxlZnRDYW52YXNIaXQgPSB0aGlzLnNlYXJjaFJlc3VsdC5oaXRzLmZpbmQoXG4gICAgICBoID0+IGguaW5kZXggPT09IGxlZnRDYW52YXNcbiAgICApO1xuICAgIGlmIChsZWZ0Q2FudmFzSGl0KSB7XG4gICAgICBwcmV2aW91c0hpdCA9IGxlZnRDYW52YXNIaXQ7XG4gICAgfSBlbHNlIGlmIChjYW52YXNlc1BlckNhbnZhc0dyb3VwLmxlbmd0aCA9PT0gMikge1xuICAgICAgY29uc3QgcmlnaHRDYW52YXMgPSBjYW52YXNlc1BlckNhbnZhc0dyb3VwWzFdO1xuICAgICAgcHJldmlvdXNIaXQgPSB0aGlzLnNlYXJjaFJlc3VsdC5oaXRzLmZpbmQoaCA9PiBoLmluZGV4ID09PSByaWdodENhbnZhcyk7XG4gICAgfVxuICAgIHJldHVybiBwcmV2aW91c0hpdDtcbiAgfVxuXG4gIHByaXZhdGUgZmluZEhpdE9uQWN0aXZlQ2FudmFzR3JvdXAoKSB7XG4gICAgcmV0dXJuIChcbiAgICAgIHRoaXMuY2FudmFzZXNQZXJDYW52YXNHcm91cC5pbmRleE9mKFxuICAgICAgICB0aGlzLnNlYXJjaFJlc3VsdC5nZXQodGhpcy5jdXJyZW50SW5kZXgpLmluZGV4XG4gICAgICApID49IDBcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBmaW5kQ3VycmVudEhpdEluZGV4KGNhbnZhc0dyb3VwSW5kZXhlczogbnVtYmVyW10pOiBudW1iZXIge1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5zZWFyY2hSZXN1bHQuc2l6ZSgpOyBpKyspIHtcbiAgICAgIGNvbnN0IGhpdCA9IHRoaXMuc2VhcmNoUmVzdWx0LmdldChpKTtcbiAgICAgIGlmIChjYW52YXNHcm91cEluZGV4ZXMuaW5kZXhPZihoaXQuaW5kZXgpID49IDApIHtcbiAgICAgICAgcmV0dXJuIGk7XG4gICAgICB9XG4gICAgICBpZiAoaGl0LmluZGV4ID49IGNhbnZhc0dyb3VwSW5kZXhlc1tjYW52YXNHcm91cEluZGV4ZXMubGVuZ3RoIC0gMV0pIHtcbiAgICAgICAgaWYgKGkgPT09IDApIHtcbiAgICAgICAgICByZXR1cm4gLTE7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgY29uc3QgcGhpdCA9IHRoaXMuc2VhcmNoUmVzdWx0LmdldChpIC0gMSk7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuc2VhcmNoUmVzdWx0LmhpdHMuZmluZEluZGV4KFxuICAgICAgICAgICAgc3IgPT4gc3IuaW5kZXggPT09IHBoaXQuaW5kZXhcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB0aGlzLnNlYXJjaFJlc3VsdC5zaXplKCkgLSAxO1xuICB9XG5cbiAgcHJpdmF0ZSBpc0ZpcnN0SGl0T25DYW52YXNHcm91cCgpIHtcbiAgICByZXR1cm4gdGhpcy5jdXJyZW50SW5kZXggPD0gMDtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0TGFzdENhbnZhc0dyb3VwSW5kZXgoY2FudmFzZXNQZXJDYW52YXNHcm91cDogbnVtYmVyW10pIHtcbiAgICByZXR1cm4gY2FudmFzZXNQZXJDYW52YXNHcm91cC5sZW5ndGggPT09IDFcbiAgICAgID8gY2FudmFzZXNQZXJDYW52YXNHcm91cFswXVxuICAgICAgOiBjYW52YXNlc1BlckNhbnZhc0dyb3VwWzFdO1xuICB9XG59XG4iXX0=