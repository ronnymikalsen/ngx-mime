import { Direction } from '../models/direction';
import { ViewerMode } from '../models/viewer-mode';
import { ViewerOptions } from '../models/viewer-options';
import { ViewingDirection } from '../models/viewing-direction';
import { CalculateNextCanvasGroupFactory } from './calculate-next-canvas-group-factory';
export class DefaultGoToCanvasGroupStrategy {
    constructor(viewer, zoomStrategy, canvasService, modeService, config, viewingDirection) {
        this.viewer = viewer;
        this.zoomStrategy = zoomStrategy;
        this.canvasService = canvasService;
        this.modeService = modeService;
        this.config = config;
        this.viewingDirection = viewingDirection;
    }
    goToCanvasGroup(canvasGroup) {
        const oldCanvasGroupIndex = this.canvasService.currentCanvasGroupIndex;
        this.canvasService.currentCanvasGroupIndex = this.canvasService.constrainToRange(canvasGroup.canvasGroupIndex);
        const newCanvasGroup = this.canvasService.getCanvasGroupRect(this.canvasService.currentCanvasGroupIndex);
        if (this.modeService.isPageZoomed() &&
            this.config.preserveZoomOnCanvasGroupChange) {
            let x;
            if (oldCanvasGroupIndex > canvasGroup.canvasGroupIndex) {
                if (this.config.startOnTopOnCanvasGroupChange) {
                    const canvasGroupIndexes = this.canvasService.getCanvasesPerCanvasGroup(canvasGroup.canvasGroupIndex);
                    const previousCanvasIndex = canvasGroupIndexes[canvasGroupIndexes.length - 1];
                    const previousCanvasRect = this.canvasService.getCanvasRect(previousCanvasIndex);
                    x =
                        this.viewingDirection === ViewingDirection.LTR
                            ? this.leftX(previousCanvasRect)
                            : this.rightX(newCanvasGroup);
                }
                else {
                    x =
                        this.viewingDirection === ViewingDirection.LTR
                            ? this.rightX(newCanvasGroup)
                            : this.leftX(newCanvasGroup);
                }
            }
            else {
                x =
                    this.viewingDirection === ViewingDirection.LTR
                        ? this.leftX(newCanvasGroup)
                        : this.rightX(newCanvasGroup);
            }
            const y = this.config.startOnTopOnCanvasGroupChange &&
                oldCanvasGroupIndex !== canvasGroup.canvasGroupIndex
                ? newCanvasGroup.y +
                    this.getViewportBounds().height / 2 -
                    this.viewer.collectionTileMargin
                : this.getViewportCenter().y;
            this.panTo(x, y, canvasGroup.immediately);
        }
        else if (this.modeService.isPageZoomed()) {
            const oldCanvasGroupCenter = this.canvasService.getCanvasGroupRect(oldCanvasGroupIndex);
            this.panToCenter(oldCanvasGroupCenter, canvasGroup.immediately);
            this.zoomStrategy.goToHomeZoom();
            setTimeout(() => {
                this.panToCenter(newCanvasGroup, canvasGroup.immediately);
                this.modeService.mode = ViewerMode.PAGE;
            }, ViewerOptions.transitions.OSDAnimationTime);
        }
        else {
            this.panToCenter(newCanvasGroup, canvasGroup.immediately);
        }
    }
    goToPreviousCanvasGroup(currentCanvasIndex) {
        if (this.canvasService.currentCanvasGroupIndex > 0) {
            const viewportCenter = this.getViewportCenter();
            const currentCanvasGroupIndex = this.canvasService.findClosestCanvasGroupIndex(viewportCenter);
            const calculateNextCanvasGroupStrategy = CalculateNextCanvasGroupFactory.create(ViewerMode.NAVIGATOR);
            const newCanvasGroupIndex = calculateNextCanvasGroupStrategy.calculateNextCanvasGroup({
                direction: Direction.PREVIOUS,
                currentCanvasGroupIndex: currentCanvasGroupIndex,
                currentCanvasGroupCenter: currentCanvasIndex,
                viewingDirection: this.viewingDirection,
            });
            this.goToCanvasGroup({
                canvasGroupIndex: newCanvasGroupIndex,
                immediately: false,
            });
        }
    }
    goToNextCanvasGroup(currentCanvasIndex) {
        if (this.canvasService.currentCanvasGroupIndex <
            this.canvasService.numberOfCanvasGroups) {
            const viewportCenter = this.getViewportCenter();
            const currentCanvasGroupIndex = this.canvasService.findClosestCanvasGroupIndex(viewportCenter);
            const calculateNextCanvasGroupStrategy = CalculateNextCanvasGroupFactory.create(ViewerMode.NAVIGATOR);
            const newCanvasGroupIndex = calculateNextCanvasGroupStrategy.calculateNextCanvasGroup({
                direction: Direction.NEXT,
                currentCanvasGroupIndex: currentCanvasGroupIndex,
                currentCanvasGroupCenter: currentCanvasIndex,
                viewingDirection: this.viewingDirection,
            });
            this.goToCanvasGroup({
                canvasGroupIndex: newCanvasGroupIndex,
                immediately: false,
            });
        }
    }
    centerCurrentCanvas() {
        const currentCanvasGroupIndex = this.canvasService.currentCanvasGroupIndex;
        const currentCanvasGroupCenter = this.canvasService.getCanvasGroupRect(currentCanvasGroupIndex);
        this.panToCenter(currentCanvasGroupCenter, false);
    }
    leftX(canvas) {
        return canvas.x + this.getViewportBounds().width / 2;
    }
    rightX(canvas) {
        return canvas.x + canvas.width - this.getViewportBounds().width / 2;
    }
    panToCenter(canvasGroup, immediately = false) {
        this.panTo(canvasGroup.centerX, canvasGroup.centerY, immediately);
    }
    panTo(x, y, immediately = false) {
        this.viewer.viewport.panTo({
            x: x,
            y: y,
        }, immediately);
    }
    getViewportCenter() {
        return this.viewer.viewport.getCenter(true);
    }
    getViewportBounds() {
        return this.viewer.viewport.getBounds(true);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ28tdG8tY2FudmFzLWdyb3VwLXN0cmF0ZWd5LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vbGlicy9uZ3gtbWltZS9zcmMvbGliL2NvcmUvdmlld2VyLXNlcnZpY2UvZ28tdG8tY2FudmFzLWdyb3VwLXN0cmF0ZWd5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUdBLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUdoRCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDbkQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQ3pELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBQy9ELE9BQU8sRUFBRSwrQkFBK0IsRUFBRSxNQUFNLHVDQUF1QyxDQUFDO0FBZ0J4RixNQUFNLE9BQU8sOEJBQThCO0lBQ3pDLFlBQ1UsTUFBVyxFQUNYLFlBQXNCLEVBQ3RCLGFBQTRCLEVBQzVCLFdBQXdCLEVBQ3hCLE1BQXdCLEVBQ3hCLGdCQUFrQztRQUxsQyxXQUFNLEdBQU4sTUFBTSxDQUFLO1FBQ1gsaUJBQVksR0FBWixZQUFZLENBQVU7UUFDdEIsa0JBQWEsR0FBYixhQUFhLENBQWU7UUFDNUIsZ0JBQVcsR0FBWCxXQUFXLENBQWE7UUFDeEIsV0FBTSxHQUFOLE1BQU0sQ0FBa0I7UUFDeEIscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtJQUN6QyxDQUFDO0lBRUosZUFBZSxDQUFDLFdBQXdCO1FBQ3RDLE1BQU0sbUJBQW1CLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyx1QkFBdUIsQ0FBQztRQUN2RSxJQUFJLENBQUMsYUFBYSxDQUFDLHVCQUF1QixHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsZ0JBQWdCLENBQzlFLFdBQVcsQ0FBQyxnQkFBZ0IsQ0FDN0IsQ0FBQztRQUNGLE1BQU0sY0FBYyxHQUFHLElBQUksQ0FB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UUFBUSxDQUFDLEtBQUssQ0FDeEI7WUFDRSxDQUFDLEVBQUUsQ0FBQztZQUNKLENBQUMsRUFBRSxDQUFDO1NBQ0wsRUFDRCxXQUFXLENBQ1osQ0FBQztJQUNKLENBQUM7SUFFTyxpQkFBaUI7UUFDdkIsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDOUMsQ0FBQztJQUVPLGlCQUFpQjtRQUN2QixPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUM5QyxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDYW52YXNTZXJ2aWNlIH0gZnJvbSAnLi4vY2FudmFzLXNlcnZpY2UvY2FudmFzLXNlcnZpY2UnO1xuaW1wb3J0IHsgTWltZVZpZXdlckNvbmZpZyB9IGZyb20gJy4uL21pbWUtdmlld2VyLWNvbmZpZyc7XG5pbXBvcnQgeyBNb2RlU2VydmljZSB9IGZyb20gJy4uL21vZGUtc2VydmljZS9tb2RlLnNlcnZpY2UnO1xuaW1wb3J0IHsgRGlyZWN0aW9uIH0gZnJvbSAnLi4vbW9kZWxzL2RpcmVjdGlvbic7XG5pbXBvcnQgeyBQb2ludCB9IGZyb20gJy4uL21vZGVscy9wb2ludCc7XG5pbXBvcnQgeyBSZWN0IH0gZnJvbSAnLi4vbW9kZWxzL3JlY3QnO1xuaW1wb3J0IHsgVmlld2VyTW9kZSB9IGZyb20gJy4uL21vZGVscy92aWV3ZXItbW9kZSc7XG5pbXBvcnQgeyBWaWV3ZXJPcHRpb25zIH0gZnJvbSAnLi4vbW9kZWxzL3ZpZXdlci1vcHRpb25zJztcbmltcG9ydCB7IFZpZXdpbmdEaXJlY3Rpb24gfSBmcm9tICcuLi9tb2RlbHMvdmlld2luZy1kaXJlY3Rpb24nO1xuaW1wb3J0IHsgQ2FsY3VsYXRlTmV4dENhbnZhc0dyb3VwRmFjdG9yeSB9IGZyb20gJy4vY2FsY3VsYXRlLW5leHQtY2FudmFzLWdyb3VwLWZhY3RvcnknO1xuaW1wb3J0IHsgU3RyYXRlZ3kgfSBmcm9tICcuL3pvb20tc3RyYXRlZ3knO1xuXG5leHBvcnQgaW50ZXJmYWNlIENhbnZhc0dyb3VwIHtcbiAgY2FudmFzR3JvdXBJbmRleDogbnVtYmVyO1xuICBkaXJlY3Rpb24/OiBEaXJlY3Rpb247XG4gIGltbWVkaWF0ZWx5PzogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBHb1RvQ2FudmFzR3JvdXBTdHJhdGVneSB7XG4gIGdvVG9DYW52YXNHcm91cChjYW52YXNHcm91cDogQ2FudmFzR3JvdXApOiB2b2lkO1xuICBnb1RvUHJldmlvdXNDYW52YXNHcm91cChjdXJyZW50Q2FudmFzSW5kZXg6IG51bWJlcik6IHZvaWQ7XG4gIGdvVG9OZXh0Q2FudmFzR3JvdXAoY3VycmVudENhbnZhc0luZGV4OiBudW1iZXIpOiB2b2lkO1xuICBjZW50ZXJDdXJyZW50Q2FudmFzKCk6IHZvaWQ7XG59XG5cbmV4cG9ydCBjbGFzcyBEZWZhdWx0R29Ub0NhbnZhc0dyb3VwU3RyYXRlZ3kgaW1wbGVtZW50cyBHb1RvQ2FudmFzR3JvdXBTdHJhdGVneSB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgdmlld2VyOiBhbnksXG4gICAgcHJpdmF0ZSB6b29tU3RyYXRlZ3k6IFN0cmF0ZWd5LFxuICAgIHByaXZhdGUgY2FudmFzU2VydmljZTogQ2FudmFzU2VydmljZSxcbiAgICBwcml2YXRlIG1vZGVTZXJ2aWNlOiBNb2RlU2VydmljZSxcbiAgICBwcml2YXRlIGNvbmZpZzogTWltZVZpZXdlckNvbmZpZyxcbiAgICBwcml2YXRlIHZpZXdpbmdEaXJlY3Rpb246IFZpZXdpbmdEaXJlY3Rpb25cbiAgKSB7fVxuXG4gIGdvVG9DYW52YXNHcm91cChjYW52YXNHcm91cDogQ2FudmFzR3JvdXApIHtcbiAgICBjb25zdCBvbGRDYW52YXNHcm91cEluZGV4ID0gdGhpcy5jYW52YXNTZXJ2aWNlLmN1cnJlbnRDYW52YXNHcm91cEluZGV4O1xuICAgIHRoaXMuY2FudmFzU2VydmljZS5jdXJyZW50Q2FudmFzR3JvdXBJbmRleCA9IHRoaXMuY2FudmFzU2VydmljZS5jb25zdHJhaW5Ub1JhbmdlKFxuICAgICAgY2FudmFzR3JvdXAuY2FudmFzR3JvdXBJbmRleFxuICAgICk7XG4gICAgY29uc3QgbmV3Q2FudmFzR3JvdXAgPSB0aGlzLmNhbnZhc1NlcnZpY2UuZ2V0Q2FudmFzR3JvdXBSZWN0KFxuICAgICAgdGhpcy5jYW52YXNTZXJ2aWNlLmN1cnJlbnRDYW52YXNHcm91cEluZGV4XG4gICAgKTtcbiAgICBpZiAoXG4gICAgICB0aGlzLm1vZGVTZXJ2aWNlLmlzUGFnZVpvb21lZCgpICYmXG4gICAgICB0aGlzLmNvbmZpZy5wcmVzZXJ2ZVpvb21PbkNhbnZhc0dyb3VwQ2hhbmdlXG4gICAgKSB7XG4gICAgICBsZXQgeDogbnVtYmVyO1xuXG4gICAgICBpZiAob2xkQ2FudmFzR3JvdXBJbmRleCA+IGNhbnZhc0dyb3VwLmNhbnZhc0dyb3VwSW5kZXgpIHtcbiAgICAgICAgaWYgKHRoaXMuY29uZmlnLnN0YXJ0T25Ub3BPbkNhbnZhc0dyb3VwQ2hhbmdlKSB7XG4gICAgICAgICAgY29uc3QgY2FudmFzR3JvdXBJbmRleGVzID0gdGhpcy5jYW52YXNTZXJ2aWNlLmdldENhbnZhc2VzUGVyQ2FudmFzR3JvdXAoXG4gICAgICAgICAgICBjYW52YXNHcm91cC5jYW52YXNHcm91cEluZGV4XG4gICAgICAgICAgKTtcbiAgICAgICAgICBjb25zdCBwcmV2aW91c0NhbnZhc0luZGV4ID1cbiAgICAgICAgICAgIGNhbnZhc0dyb3VwSW5kZXhlc1tjYW52YXNHcm91cEluZGV4ZXMubGVuZ3RoIC0gMV07XG4gICAgICAgICAgY29uc3QgcHJldmlvdXNDYW52YXNSZWN0ID0gdGhpcy5jYW52YXNTZXJ2aWNlLmdldENhbnZhc1JlY3QoXG4gICAgICAgICAgICBwcmV2aW91c0NhbnZhc0luZGV4XG4gICAgICAgICAgKTtcbiAgICAgICAgICB4ID1cbiAgICAgICAgICAgIHRoaXMudmlld2luZ0RpcmVjdGlvbiA9PT0gVmlld2luZ0RpcmVjdGlvbi5MVFJcbiAgICAgICAgICAgICAgPyB0aGlzLmxlZnRYKHByZXZpb3VzQ2FudmFzUmVjdClcbiAgICAgICAgICAgICAgOiB0aGlzLnJpZ2h0WChuZXdDYW52YXNHcm91cCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgeCA9XG4gICAgICAgICAgICB0aGlzLnZpZXdpbmdEaXJlY3Rpb24gPT09IFZpZXdpbmdEaXJlY3Rpb24uTFRSXG4gICAgICAgICAgICAgID8gdGhpcy5yaWdodFgobmV3Q2FudmFzR3JvdXApXG4gICAgICAgICAgICAgIDogdGhpcy5sZWZ0WChuZXdDYW52YXNHcm91cCk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHggPVxuICAgICAgICAgIHRoaXMudmlld2luZ0RpcmVjdGlvbiA9PT0gVmlld2luZ0RpcmVjdGlvbi5MVFJcbiAgICAgICAgICAgID8gdGhpcy5sZWZ0WChuZXdDYW52YXNHcm91cClcbiAgICAgICAgICAgIDogdGhpcy5yaWdodFgobmV3Q2FudmFzR3JvdXApO1xuICAgICAgfVxuXG4gICAgICBjb25zdCB5ID1cbiAgICAgICAgdGhpcy5jb25maWcuc3RhcnRPblRvcE9uQ2FudmFzR3JvdXBDaGFuZ2UgJiZcbiAgICAgICAgb2xkQ2FudmFzR3JvdXBJbmRleCAhPT0gY2FudmFzR3JvdXAuY2FudmFzR3JvdXBJbmRleFxuICAgICAgICAgID8gbmV3Q2FudmFzR3JvdXAueSArXG4gICAgICAgICAgICB0aGlzLmdldFZpZXdwb3J0Qm91bmRzKCkuaGVpZ2h0IC8gMiAtXG4gICAgICAgICAgICB0aGlzLnZpZXdlci5jb2xsZWN0aW9uVGlsZU1hcmdpblxuICAgICAgICAgIDogdGhpcy5nZXRWaWV3cG9ydENlbnRlcigpLnk7XG5cbiAgICAgIHRoaXMucGFuVG8oeCwgeSwgY2FudmFzR3JvdXAuaW1tZWRpYXRlbHkpO1xuICAgIH0gZWxzZSBpZiAodGhpcy5tb2RlU2VydmljZS5pc1BhZ2Vab29tZWQoKSkge1xuICAgICAgY29uc3Qgb2xkQ2FudmFzR3JvdXBDZW50ZXIgPSB0aGlzLmNhbnZhc1NlcnZpY2UuZ2V0Q2FudmFzR3JvdXBSZWN0KFxuICAgICAgICBvbGRDYW52YXNHcm91cEluZGV4XG4gICAgICApO1xuICAgICAgdGhpcy5wYW5Ub0NlbnRlcihvbGRDYW52YXNHcm91cENlbnRlciwgY2FudmFzR3JvdXAuaW1tZWRpYXRlbHkpO1xuICAgICAgdGhpcy56b29tU3RyYXRlZ3kuZ29Ub0hvbWVab29tKCk7XG4gICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgdGhpcy5wYW5Ub0NlbnRlcihuZXdDYW52YXNHcm91cCwgY2FudmFzR3JvdXAuaW1tZWRpYXRlbHkpO1xuICAgICAgICB0aGlzLm1vZGVTZXJ2aWNlLm1vZGUgPSBWaWV3ZXJNb2RlLlBBR0U7XG4gICAgICB9LCBWaWV3ZXJPcHRpb25zLnRyYW5zaXRpb25zLk9TREFuaW1hdGlvblRpbWUpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnBhblRvQ2VudGVyKG5ld0NhbnZhc0dyb3VwLCBjYW52YXNHcm91cC5pbW1lZGlhdGVseSk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGdvVG9QcmV2aW91c0NhbnZhc0dyb3VwKGN1cnJlbnRDYW52YXNJbmRleDogbnVtYmVyKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuY2FudmFzU2VydmljZS5jdXJyZW50Q2FudmFzR3JvdXBJbmRleCA+IDApIHtcbiAgICAgIGNvbnN0IHZpZXdwb3J0Q2VudGVyID0gdGhpcy5nZXRWaWV3cG9ydENlbnRlcigpO1xuICAgICAgY29uc3QgY3VycmVudENhbnZhc0dyb3VwSW5kZXggPSB0aGlzLmNhbnZhc1NlcnZpY2UuZmluZENsb3Nlc3RDYW52YXNHcm91cEluZGV4KFxuICAgICAgICB2aWV3cG9ydENlbnRlclxuICAgICAgKTtcblxuICAgICAgY29uc3QgY2FsY3VsYXRlTmV4dENhbnZhc0dyb3VwU3RyYXRlZ3kgPSBDYWxjdWxhdGVOZXh0Q2FudmFzR3JvdXBGYWN0b3J5LmNyZWF0ZShcbiAgICAgICAgVmlld2VyTW9kZS5OQVZJR0FUT1JcbiAgICAgICk7XG4gICAgICBjb25zdCBuZXdDYW52YXNHcm91cEluZGV4ID0gY2FsY3VsYXRlTmV4dENhbnZhc0dyb3VwU3RyYXRlZ3kuY2FsY3VsYXRlTmV4dENhbnZhc0dyb3VwKFxuICAgICAgICB7XG4gICAgICAgICAgZGlyZWN0aW9uOiBEaXJlY3Rpb24uUFJFVklPVVMsXG4gICAgICAgICAgY3VycmVudENhbnZhc0dyb3VwSW5kZXg6IGN1cnJlbnRDYW52YXNHcm91cEluZGV4LFxuICAgICAgICAgIGN1cnJlbnRDYW52YXNHcm91cENlbnRlcjogY3VycmVudENhbnZhc0luZGV4LFxuICAgICAgICAgIHZpZXdpbmdEaXJlY3Rpb246IHRoaXMudmlld2luZ0RpcmVjdGlvbixcbiAgICAgICAgfVxuICAgICAgKTtcbiAgICAgIHRoaXMuZ29Ub0NhbnZhc0dyb3VwKHtcbiAgICAgICAgY2FudmFzR3JvdXBJbmRleDogbmV3Q2FudmFzR3JvdXBJbmRleCxcbiAgICAgICAgaW1tZWRpYXRlbHk6IGZhbHNlLFxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGdvVG9OZXh0Q2FudmFzR3JvdXAoY3VycmVudENhbnZhc0luZGV4OiBudW1iZXIpOiB2b2lkIHtcbiAgICBpZiAoXG4gICAgICB0aGlzLmNhbnZhc1NlcnZpY2UuY3VycmVudENhbnZhc0dyb3VwSW5kZXggPFxuICAgICAgdGhpcy5jYW52YXNTZXJ2aWNlLm51bWJlck9mQ2FudmFzR3JvdXBzXG4gICAgKSB7XG4gICAgICBjb25zdCB2aWV3cG9ydENlbnRlciA9IHRoaXMuZ2V0Vmlld3BvcnRDZW50ZXIoKTtcbiAgICAgIGNvbnN0IGN1cnJlbnRDYW52YXNHcm91cEluZGV4ID0gdGhpcy5jYW52YXNTZXJ2aWNlLmZpbmRDbG9zZXN0Q2FudmFzR3JvdXBJbmRleChcbiAgICAgICAgdmlld3BvcnRDZW50ZXJcbiAgICAgICk7XG5cbiAgICAgIGNvbnN0IGNhbGN1bGF0ZU5leHRDYW52YXNHcm91cFN0cmF0ZWd5ID0gQ2FsY3VsYXRlTmV4dENhbnZhc0dyb3VwRmFjdG9yeS5jcmVhdGUoXG4gICAgICAgIFZpZXdlck1vZGUuTkFWSUdBVE9SXG4gICAgICApO1xuICAgICAgY29uc3QgbmV3Q2FudmFzR3JvdXBJbmRleCA9IGNhbGN1bGF0ZU5leHRDYW52YXNHcm91cFN0cmF0ZWd5LmNhbGN1bGF0ZU5leHRDYW52YXNHcm91cChcbiAgICAgICAge1xuICAgICAgICAgIGRpcmVjdGlvbjogRGlyZWN0aW9uLk5FWFQsXG4gICAgICAgICAgY3VycmVudENhbnZhc0dyb3VwSW5kZXg6IGN1cnJlbnRDYW52YXNHcm91cEluZGV4LFxuICAgICAgICAgIGN1cnJlbnRDYW52YXNHcm91cENlbnRlcjogY3VycmVudENhbnZhc0luZGV4LFxuICAgICAgICAgIHZpZXdpbmdEaXJlY3Rpb246IHRoaXMudmlld2luZ0RpcmVjdGlvbixcbiAgICAgICAgfVxuICAgICAgKTtcbiAgICAgIHRoaXMuZ29Ub0NhbnZhc0dyb3VwKHtcbiAgICAgICAgY2FudmFzR3JvdXBJbmRleDogbmV3Q2FudmFzR3JvdXBJbmRleCxcbiAgICAgICAgaW1tZWRpYXRlbHk6IGZhbHNlLFxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGNlbnRlckN1cnJlbnRDYW52YXMoKTogdm9pZCB7XG4gICAgY29uc3QgY3VycmVudENhbnZhc0dyb3VwSW5kZXggPSB0aGlzLmNhbnZhc1NlcnZpY2UuY3VycmVudENhbnZhc0dyb3VwSW5kZXg7XG4gICAgY29uc3QgY3VycmVudENhbnZhc0dyb3VwQ2VudGVyID0gdGhpcy5jYW52YXNTZXJ2aWNlLmdldENhbnZhc0dyb3VwUmVjdChcbiAgICAgIGN1cnJlbnRDYW52YXNHcm91cEluZGV4XG4gICAgKTtcbiAgICB0aGlzLnBhblRvQ2VudGVyKGN1cnJlbnRDYW52YXNHcm91cENlbnRlciwgZmFsc2UpO1xuICB9XG5cbiAgcHJpdmF0ZSBsZWZ0WChjYW52YXM6IFJlY3QpOiBudW1iZXIge1xuICAgIHJldHVybiBjYW52YXMueCArIHRoaXMuZ2V0Vmlld3BvcnRCb3VuZHMoKS53aWR0aCAvIDI7XG4gIH1cblxuICBwcml2YXRlIHJpZ2h0WChjYW52YXM6IFJlY3QpOiBudW1iZXIge1xuICAgIHJldHVybiBjYW52YXMueCArIGNhbnZhcy53aWR0aCAtIHRoaXMuZ2V0Vmlld3BvcnRCb3VuZHMoKS53aWR0aCAvIDI7XG4gIH1cblxuICBwcml2YXRlIHBhblRvQ2VudGVyKGNhbnZhc0dyb3VwOiBSZWN0LCBpbW1lZGlhdGVseSA9IGZhbHNlKTogdm9pZCB7XG4gICAgdGhpcy5wYW5UbyhjYW52YXNHcm91cC5jZW50ZXJYLCBjYW52YXNHcm91cC5jZW50ZXJZLCBpbW1lZGlhdGVseSk7XG4gIH1cblxuICBwcml2YXRlIHBhblRvKHg6IG51bWJlciwgeTogbnVtYmVyLCBpbW1lZGlhdGVseSA9IGZhbHNlKTogdm9pZCB7XG4gICAgdGhpcy52aWV3ZXIudmlld3BvcnQucGFuVG8oXG4gICAgICB7XG4gICAgICAgIHg6IHgsXG4gICAgICAgIHk6IHksXG4gICAgICB9LFxuICAgICAgaW1tZWRpYXRlbHlcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRWaWV3cG9ydENlbnRlcigpOiBQb2ludCB7XG4gICAgcmV0dXJuIHRoaXMudmlld2VyLnZpZXdwb3J0LmdldENlbnRlcih0cnVlKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0Vmlld3BvcnRCb3VuZHMoKTogUmVjdCB7XG4gICAgcmV0dXJuIHRoaXMudmlld2VyLnZpZXdwb3J0LmdldEJvdW5kcyh0cnVlKTtcbiAgfVxufVxuIl19